(ns lupapalvelu.property-api
  (:require [sade.core :refer :all]
            [sade.property :as p]
            [sade.validators :as v]
            [lupapalvelu.action :refer [defquery] :as action]
            [lupapalvelu.wfs :as wfs]))

(defquery municipality-by-property-id
  {:parameters [propertyId]
   :user-roles #{:anonymous}}
  [_]
  (if-let [municipality (p/municipality-id-by-property-id propertyId)]
    (ok :municipality municipality)
    (fail :municipalitysearch.notfound)))

(defquery property-borders
  {:parameters [propertyIds]
   :description "Returns property borders as POLYGON WKT strings"
   :user-roles #{:authority} ; At the time of writing the only use case is the neighbour map
   :input-validators [(partial action/vector-parameter-of :propertyIds v/kiinteistotunnus?)]}
  [_]
  ;(fail! :error.ktj-down)
  (let [property-ids (set propertyIds)
        ; NLS WFS service does not support or-query, need to fetch areas one by one (in parallel)
        features (pmap (comp (partial map wfs/feature-to-area) wfs/location-info-by-property-id) property-ids)
        areas (->> features flatten (remove nil?))]

    (if (seq areas)
      (do
        (println "areas" areas)
        (ok :wkts (map :wkt areas)))
      ;{"ok" true,"wkts" ["POLYGON((404952.641 6694538.097, 405230.442 6694632.160, 405272.103 6694646.272, 405276.270 6694648.332, 405284.408 6694629.608, 405284.919 6694628.593, 405288.465 6694621.426, 405286.179 6694618.688, 405287.163 6694598.701, 405400.733 6694384.884, 405407.499 6694368.789, 405408.561 6694351.377, 405408.497 6694344.541, 405383.696 6694342.444, 405370.221 6694346.391, 405308.036 6694375.682, 405254.953 6694399.139, 405244.216 6694400.569, 405227.198 6694409.817, 405195.582 6694421.278, 405074.963 6694460.923, 405036.154 6694475.220, 405002.430 6694484.082, 404948.974 6694505.123, 404936.314 6694511.034, 404940.612 6694515.199, 404951.863 6694526.666, 404952.641 6694538.097))","POLYGON((405067.127 6694427.726, 405165.658 6694394.619, 405215.707 6694380.840, 405233.042 6694375.443, 405235.602 6694374.828, 405279.854 6694354.949, 405315.415 6694338.587, 405338.528 6694329.989, 405398.148 6694304.521, 405381.303 6694308.016, 405373.450 6694309.519, 405371.472 6694309.811, 405371.111 6694309.859, 405369.125 6694310.088, 405367.133 6694310.249, 405365.136 6694310.335, 405363.136 6694310.325, 405361.141 6694310.200, 405359.762 6694310.042, 405357.790 6694309.716, 405355.834 6694309.298, 405354.278 6694308.942, 405348.531 6694311.503, 405338.316 6694316.069, 405328.671 6694319.248, 405324.674 6694307.549, 405318.039 6694294.894, 405307.036 6694290.117, 405306.661 6694289.956, 405265.785 6694273.738, 405242.877 6694266.027, 405221.819 6694259.693, 405219.986 6694259.139, 405185.509 6694248.839, 405183.574 6694248.334, 405182.949 6694248.173, 405170.412 6694245.380, 405143.923 6694239.480, 405118.753 6694233.013, 405106.987 6694230.688, 405103.037 6694230.071, 405101.748 6694229.886, 405085.897 6694227.760, 405084.962 6694227.597, 405082.998 6694227.228, 405082.205 6694227.076, 405081.147 6694233.068, 405075.189 6694234.634, 405020.124 6694249.099, 405014.735 6694225.924, 405011.352 6694220.352, 405001.426 6694221.529, 404999.452 6694221.840, 404998.536 6694221.997, 404990.719 6694223.675, 404969.273 6694229.389, 404961.449 6694231.042, 404951.571 6694232.564, 404949.530 6694232.806, 404935.415 6694234.033, 404934.057 6694243.193, 404979.917 6694432.344, 404984.695 6694452.326, 404991.655 6694450.636, 405008.942 6694445.093, 405024.691 6694438.787, 405067.127 6694427.726))","POLYGON((404674.316 6694219.774, 404676.389 6694225.401, 404676.522 6694225.729, 404677.309 6694227.567, 404678.147 6694229.382, 404680.894 6694234.713, 404687.900 6694246.827, 404688.367 6694247.654, 404693.009 6694256.506, 404693.884 6694258.303, 404702.846 6694278.384, 404703.241 6694279.287, 404719.501 6694315.815, 404720.020 6694317.013, 404723.805 6694326.263, 404724.510 6694328.134, 404725.191 6694330.013, 404725.835 6694331.906, 404726.429 6694333.815, 404726.966 6694335.740, 404727.858 6694339.638, 404728.216 6694341.605, 404728.522 6694343.654, 404728.914 6694347.632, 404729.706 6694363.607, 404729.907 6694365.596, 404730.180 6694367.576, 404730.536 6694369.543, 404730.984 6694371.492, 404731.537 6694373.413, 404732.207 6694375.295, 404733.011 6694377.125, 404733.962 6694378.884, 404734.913 6694380.327, 404736.153 6694381.894, 404737.518 6694383.355, 404738.988 6694384.708, 404740.542 6694385.967, 404742.155 6694387.146, 404743.822 6694388.250, 404744.804 6694388.853, 404746.539 6694389.846, 404748.310 6694390.774, 404750.113 6694391.637, 404751.947 6694392.433, 404753.807 6694393.164, 404755.693 6694393.829, 404759.523 6694394.976, 404761.458 6694395.477, 404763.404 6694395.932, 404767.327 6694396.709, 404769.299 6694397.035, 404770.999 6694397.281, 404778.952 6694398.114, 404804.926 6694398.897, 404806.924 6694398.942, 404807.472 6694398.957, 404817.452 6694399.512, 404821.430 6694399.906, 404823.413 6694400.160, 404827.356 6694400.823, 404829.309 6694401.250, 404831.246 6694401.742, 404833.165 6694402.303, 404835.063 6694402.932, 404835.828 6694403.208, 404837.689 6694403.935, 404839.523 6694404.732, 404841.327 6694405.594, 404843.099 6694406.519, 404844.839 6694407.505, 404846.551 6694408.535, 404853.225 6694412.939, 404854.858 6694414.091, 404855.109 6694414.270, 404858.287 6694416.696, 404859.836 6694417.960, 404861.313 6694419.180, 404865.072 6694423.852, 404865.344 6694424.211, 404866.517 6694425.830, 404867.675 6694427.690, 404868.562 6694429.481, 404869.338 6694431.322, 404869.730 6694432.267, 404870.491 6694434.116, 404871.178 6694435.993, 404871.338 6694436.539, 404871.698 6694438.505, 404871.971 6694440.486, 404872.111 6694441.610, 404872.820 6694445.546, 404873.137 6694447.430, 404873.359 6694449.417, 404873.567 6694453.642, 404873.707 6694455.488, 404873.965 6694457.471, 404874.308 6694459.440, 404875.165 6694463.345, 404875.580 6694465.103, 404879.920 6694463.799, 404898.677 6694457.620, 404920.357 6694451.994, 404956.238 6694448.465, 404978.565 6694452.213, 404927.227 6694243.975, 404926.713 6694233.972, 404922.552 6694233.815, 404910.601 6694232.822, 404845.447 6694222.523, 404841.474 6694222.074, 404840.367 6694221.966, 404804.428 6694220.207, 404803.389 6694220.158, 404763.480 6694217.747, 404762.689 6694217.724, 404754.694 6694217.637, 404726.710 6694218.139, 404725.888 6694218.162, 404691.914 6694219.055, 404690.405 6694219.106, 404674.316 6694219.774))","POLYGON((407977.076 6693854.057, 407972.006 6693852.119, 407968.626 6693850.199, 407953.380 6693860.436, 407917.834 6693884.306, 407855.788 6693925.958, 407765.647 6693984.548, 407728.776 6694008.514, 407488.569 6694164.464, 407385.580 6694231.562, 407393.840 6694341.496, 407393.965 6694343.154, 407401.757 6694435.162, 407911.526 6694112.746, 407852.207 6693936.597, 407960.580 6693864.961, 407977.076 6693854.057))","POLYGON((408050.879 6693468.246, 408019.980 6693520.584, 408019.284 6693521.764, 408022.560 6693522.991, 408045.967 6693531.747, 408062.256 6693537.840, 408052.655 6693471.833, 408051.848 6693466.625, 408050.879 6693468.246))","POLYGON((409382.012 6691130.841, 409210.571 6690888.480, 409188.218 6690856.876, 409086.049 6690919.333, 409079.715 6690917.677, 408997.929 6690968.145, 409000.461 6690972.926, 408920.003 6691022.641, 408988.391 6691177.881, 409025.278 6691258.356, 409213.706 6691664.249, 409245.345 6691652.208, 409641.054 6691501.600, 409607.000 6691421.797, 409575.874 6691349.165, 409476.679 6691111.101, 409382.012 6691130.841))"]}
      (fail :error.ktj-down))))
