<!DOCTYPE html>
<html >
<body>
  <section class="page container" id="attachment" data-bind="with: attachment">
    <!-- ko if: init -->
    <div>
      <div class="attachment-info">
        <div class="container">

          <div class="attachment-info-header">
            <h1>
              <span data-bind="text: application.title"></span>: <span data-bind="ltext: name"></span>
              <span data-bind="if: latestVersion">
                <span data-bind="ltext: 'attachment.version'">versio</span>
                <span id="test-attachment-version" data-bind="version: latestVersion().version">0.0</span>
              </span>
            </h1>
            <span class="icon help" data-bind="click: toggleHelp, css: {expanded: showHelp}"></span>
          </div>

          <p data-bind="slider: showHelp, lhtml: 'attachment.view.desc'"  class="tab-info"></p>          

          <div>
            <a class="btn left-align btn-nav-back"
               data-bind="click: function() { window.location.hash = '!/application/' + application.id() + '/attachments'; repository.load(application.id()); }"
               data-test-id="back-to-application-from-attachment">
              <span data-bind =" ltext: 'attachment.return'"></span>
              <span class="icon drill-left-black-bigger left-align"></span>
            </a>
          </div>

          <div class="attachment-actions">
            <div data-bind="with: $root.approve">
              <button id="test-attachment-approve" data-bind="ltext: 'document.approve', click: approveAttachment, enable: isApprovable() && isNotOk(), visible: isApprovable()" class="btn btn-primary">Hyv&auml;ksy</button>
              <button id="test-attachment-reject" data-bind="ltext: 'attachment.reject', click: rejectAttachment, enable: isRejectable() && doesNotRequireUserAction(), visible: isRejectable()" class="btn btn-decline">Tarkennettavaa</button>
            </div>
            <button data-test-id="change-attachment-type" data-bind="ltext: 'attachment.changeType', click: showChangeTypeDialog, visible: $root.authorization.ok('set-attachment-type') && editable"></button>
            <button data-bind="ltext: 'attachment.delete', click: deleteAttachment, visible: $root.authorization.ok('delete-attachment') && editable" data-test-id="delete-attachment">Poista liite</button>
          </div>

          <div class="clear"></div>

          <div class="col1">
            <div>
              <div class="btn-container">
                <button
                    id="add-new-attachment-version"
                    class="btn-primary"
                    data-window-id="upload-dialog"
                    data-bind="click: newAttachmentVersion, visible: $root.authorization.ok('upload-attachment') && editable">
                  <span data-bind="ltext: 'attachment.addVersion', visible: latestVersion"></span>
                  <span data-bind="ltext: 'attachment.addFile', visible: !latestVersion()"></span>
                  <span class="icon add left-align"></span>
                </button>
                <button id="show-attachment-versions"
                        class="btn"
                        data-bind="click: toggleAttachmentVersionHistory, visible: latestVersion">
                  <span data-bind="ltext: 'attachment.showVersionHistory'"></span>
                  <span class="left-align"
                        data-bind="drill: showAttachmentVersionHistory, color: 'black'"></span>
                </button>
              </div>
              <div class="attachment-file-versions" data-bind="slider: showAttachmentVersionHistory">
                <h3 data-bind="ltext: 'attachment.versionHistory'">Versiohistoria:</h3>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th data-bind="ltext: 'attachment.file'">Tiedosto</th>
                      <th data-bind="ltext: 'attachment.version'">Versio</th>
                      <th data-bind="ltext: 'attachment.editDate'">Muokattu</th>
                      <th data-bind="ltext: 'attachment.editor'">Muokkaaja</th>
                      <th data-bind="ltext: 'attachment.actions'">Toiminto</th>
                    </tr>
                  </thead>
                  <tbody data-bind="foreach: versions">
                    <tr style="cursor: pointer;">
                      <td>
                        <a data-bind="text: $data.filename, attr: {href: '/api/raw/download-attachment?attachment-id=' + $data.fileId}"></a>
                      </td>
                      <td data-bind="version: version"></td>
                      <td data-bind="dateString: created"></td>
                      <td>
                        <span data-bind="fullName: user"></span>
                      </td>
                      <td>
                        <a class="link-action" data-bind="click: $root.attachment.deleteVersion, ltext: 'remove', visible: $root.authorization.ok('delete-attachment-version') && $parent.editable"></a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="signatures" data-bind="visible: latestVersion">
              <h3 data-bind="ltext: 'attachment.signatures'"></h3>
              <div class="signature-table" data-bind="if: signatures && signatures().length > 0">
                <!-- ko foreach: signatures -->
                  <div class="signature-row">
                    <div class="signature-cell" data-bind="fullName: user"></div>
                    <div class="signature-cell">
                      <span data-bind="ltext: 'attachment.version'"></span>
                      <span data-bind="version: version"></span>
                    </div>
                    <div class="signature-cell" data-bind="dateTimeString: created"></div>
                  </div>
                  <!-- /ko -->
              </div>
              <button data-test-id="signLatestAttachmentVersion" class="btn-primary"
                      data-bind="click: sign, visible: $root.authorization.ok('sign-attachments'), visible: versions().length && $root.authorization.ok('sign-attachments')">
                  <span data-bind="ltext: 'attachment.signLatest'"></span>
                  <span class="icon signed-white left-align"></span>
              </button>
            </div>
          </div>

          <div class="col2" data-bind="if: latestVersion">
            <div class="attachment-label">
              <h4 data-bind="with: latestVersion">
                <span class="attachment-label-header-item" id="test-attachment-file-name"><a data-bind="text: $data.filename, attr: {href: '/api/raw/download-attachment?attachment-id=' + $data.fileId}"></a></span>
                <span class="attachment-label-header-item">
                  <span data-bind="ltext: 'attachment.version'">Versio</span>
                  <span data-bind="version: $data.version"></span>
                </span>
                <span class="attachment-label-header-item" data-bind="dateTimeString: $data.created"></span>
                <span class="attachment-label-header-item" data-bind="fullName: $data.user"></span>
              </h4>

              <div class="attachment-info-fields">
                <div class="col1 attachment-info-field">
                  <label data-bind="ltext: 'attachment.label.contents'"></label>
                  <span class="save-indicator" data-bind="saveIndicator: indicator, name: 'contents'"></span>
                  <input class="form-input" type="text"
                         data-test-id="attachment-contents-input"
                         data-bind="value: contents,
                                    valueUpdate: 'afterkeydown',
                                    enable: $root.authorization.ok('set-attachment-meta') && editable"></input>
                </div>
                <div class="col2 attachment-info-field">
                  <label data-bind="ltext: 'attachment.label.operation'"></label>
                  <span class="save-indicator" data-bind="saveIndicator: indicator, name: 'operation'"></span>
                  <select data-test-id="attachment-operation-select"
                          data-bind="options: selectableOperations,
                                     optionsText: function(item) {return item.description ? loc([item.name, '_group_label']) + ' - ' + item.description : loc([item.name, '_group_label'])},
                                     optionsValue: 'id',
                                     optionsCaption: loc('attachment.label.operation.choose'),
                                     value: selectedOperationId,
                                     enable: $root.authorization.ok('set-attachment-meta') && editable"></select>
                </div>
                <div class="col1 attachment-info-field">
                  <label data-bind="ltext: 'attachment.label.scale'"></label>
                  <span class="save-indicator" data-bind="saveIndicator: indicator, name: 'scale'"></span>
                  <select data-test-id="attachment-scale-select"
                          data-bind="options: scales,
                                     optionsText: function(item) {return item === 'muu' ? loc('select-other') : item},
                                     optionsCaption: loc('choose'),
                                     value: scale,
                                     enable: $root.authorization.ok('set-attachment-meta') && editable"></select>
                </div>
                <div class="col2 attachment-info-field">
                  <label data-bind="ltext: 'attachment.label.size'"></label>
                  <span class="save-indicator" data-bind="saveIndicator: indicator, name: 'size'"></span>
                  <select data-test-id="attachment-size-select"
                          data-bind="options: sizes,
                                     optionsText: function(item) {return item === 'muu' ? loc('select-other') : item},
                                     optionsCaption: loc('choose'),
                                     value: size,
                                     enable: $root.authorization.ok('set-attachment-meta') && editable"></select>
                </div>
              </div>
            </div>

            <!-- Preview images and pdf files only -->
            <div class="file-preview" data-bind="visible: hasPreview()">
              <div class="file-preview-image" data-bind="if: isImage()">
                <a data-bind="attr: {href: '/api/raw/view-attachment?attachment-id=' + latestVersion().fileId}">
                  <img data-bind="attr: {src: '/api/raw/view-attachment?attachment-id=' + latestVersion().fileId}" src="/img/ajax-loader.gif" alt=""/>
                </a>
              </div>
              <div class="file-preview-pdf" data-bind="if: isPdf() || isPlainText()">
              <a class="btn" data-bind="text: loc('attachment.pdf.preview.link'), attr: {href: '/api/raw/view-attachment?attachment-id=' + latestVersion().fileId}" target="file-preview-iframe-name"></a>
                <iframe id="file-preview-iframe" name="file-preview-iframe-name"></iframe>
              </div>
            </div>

            <div id="test-txt-file-preview" class="file-preview" data-bind="visible: !hasPreview()">
              <p data-bind="ltext: 'attachment.noPreview'">Esikatselua ei saatavilla.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /ko -->

    <div class="window autosized" id="change-type-dialog">
      <div class="dialog-header">
       <p data-bind="ltext: 'attachment.changeType'"></p>
       <p class="dialog-close close">X</p>
      </div>
        <div class="form-entry change-type">
          <label for="attachment-type-select" class="form-label">
           <img src="/img/ajax-loader-12.gif" alt="..." width="12" height="12" id="attachment-type-select-loader" style="display: none;">
          </label>
          <div>
            <select id="attachment-type-select" class="long" data-bind="enable: $root.authorization.ok('set-attachment-type')"></select>
          </div>
        </div>
        <div style="text-align:center">
          <button class="btn btn-primary btn-dialog" data-test-id="confirm-yes" style="position:relative" data-bind="ltext: 'button.ok', click: LUPAPISTE.ModalDialog.close"></button>
        </div>
    </div>
  </section>
</body>
</html>
