<!DOCTYPE html>
<html >
<body>
  <section class="page container" id="attachment" data-bind="with: attachment">
    <div>
      <div class="attachment-info">
        <div class="attachment-info-header">
          <h1>
            <span data-bind="text: application.title"></span>: <span data-bind="ltext: name"></span>
            <span data-bind="if: latestVersion">
              <span data-bind="ltext: 'attachment.version'">versio</span>
              <span id="test-attachment-version" data-bind="version: latestVersion().version">0.0</span>
            </span>
          </h1>
          <a class="btn attachment-back inline-block btn-nav-back" data-bind ="attr: {href: '#!/application/' + application.id() + '/attachments' }" data-test-id="back-to-application-from-attachment">
            <span data-bind =" ltext: 'attachment.return'"></span>
            <span class="icon drill-left-black-bigger left-align"></span>
          </a>
        </div>

        <p data-bind="lhtml: 'attachment.view.desc'"  class="tab-info"></p>
         <button class="attachment-delete inline-block" data-bind="ltext: 'attachment.delete', click: deleteAttachment, visible: $root.authorization.ok('delete-attachment'),  enable: $root.authorization.ok('delete-attachment')"
          style="margin-left: 0" data-test-id="delete-attachment">Poista liite</button>
        <div data-bind="with: $root.approve" class="inline-block">
          <button id="test-attachment-approve" data-bind="ltext: 'document.approve', click: approveAttachment, enable: isApprovable() && isNotOk(), visible: isApprovable()" class="btn btn-primary">Hyv&auml;ksy</button>
          <button id="test-attachment-reject" data-bind="ltext: 'attachment.reject', click: rejectAttachment, enable: isRejectable() && doesNotRequireUserAction(), visible: isRejectable()" class="btn btn-decline">Tarkennettavaa</button>
        </div>

        <div class="form-entry change-type">
          <label for="attachment-type-select" class="form-label">
           <span data-bind="ltext: 'attachment.changeType'">Vaihda liitteen tyyppi</span>
           <img src="/img/ajax-loader-12.gif" alt="..." width="12" height="12" id="attachment-type-select-loader" style="display: none;">
          </label>
          <div><select id="attachment-type-select" class="long" data-bind="enable: $root.authorization.ok('set-attachment-type')"></select></div>

        </div>
      </div>

      <!-- Preview images and pdf files only -->
      <div class="file-preview" data-bind="visible: hasPreview()">
        <div class="file-preview-image" data-bind="if: isImage()">
          <a data-bind="attr: {href: '/api/raw/view-attachment?attachment-id=' + latestVersion().fileId}">
            <img data-bind="attr: {src: '/api/raw/view-attachment?attachment-id=' + latestVersion().fileId}" src="/img/ajax-loader.gif" alt=""/>
          </a>
        </div>
        <div class="file-preview-pdf" data-bind="if: isPdf() || isPlainText()">
        <a data-bind="text: loc('attachment.pdf.preview.link'), attr: {href: '/api/raw/view-attachment?attachment-id=' + latestVersion().fileId}" target="file-preview-iframe-name"></a>
          <iframe id="file-preview-iframe" name="file-preview-iframe-name"></iframe>
        </div>
      </div>

      <div id="test-txt-file-preview" class="file-preview" data-bind="visible: !hasPreview()">
        <p data-bind="ltext: 'attachment.noPreview'">Esikatselua ei saatavilla.</p>
      </div>

      <div class="attachment-file-versions">
        <h3 data-bind="ltext: 'attachment.versionHistory'">Versiohistoria:</h3>
        <table class="table table-striped">
          <thead>
            <tr>
              <th data-bind="ltext: 'attachment.file'">Tiedosto</th>
              <th></th>
              <th data-bind="ltext: 'attachment.version'">Versio</th>
              <th data-bind="ltext: 'attachment.editDate'">Muokattu</th>
              <th data-bind="ltext: 'attachment.editor'">Muokkaaja</th>
              <th data-bind="ltext: 'attachment.actions'">Toiminto</th>
            </tr>
          </thead>
          <tbody data-bind="foreach: versions">
            <tr style="cursor: pointer;">
              <td id="test-attachment-file-name"><a data-bind="text: $data.filename, attr: {href: '/api/raw/download-attachment?attachment-id=' + $data.fileId}"></a></td>
              <td data-bind="size: size"></td>
              <td data-bind="version: version"></td>
              <td data-bind="dateTimeString: created"></td>
              <td>
                <span data-bind="fullName: user"></span>
                (<span data-bind="ltext: user.role"></span>)
              </td>
              <td><a data-bind="click: $root.attachment.deleteVersion, ltext: 'remove', visible: $root.authorization.ok('delete-attachment-version'),  enable: $root.authorization.ok('delete-attachment-version')" ></a></td>
            </tr>
          </tbody>
        </table>

        <button
            id="add-new-attachment-version"
            class="btn"
            data-window-id="upload-dialog"
            data-bind="click: newAttachmentVersion, ltext: 'attachment.addVersion', visible: $root.authorization.ok('upload-attachment'),  enable: $root.authorization.ok('upload-attachment')">
          Lis&auml;&auml; uusi versio
        </button>
      </div>

      <div class="attachment-file-versions">
        <h3 data-bind="ltext: 'attachment.signatures'"></h3>
        <table class="table table-striped" data-bind="if: signatures && signatures().length > 0">
          <thead>
            <tr>
              <th data-bind="ltext: 'attachment.signer'"></th>
              <th data-bind="ltext: 'attachment.version'"></th>
              <th data-bind="ltext: 'attachment.signedDate'"></th>
            </tr>
          </thead>
          <tbody data-bind="foreach: signatures">
            <tr>
              <td data-bind="fullName: user"></td>
              <td data-bind="version: version"></td>
              <td data-bind="dateTimeString: created"></td>
            </tr>
          </tbody>
        </table>
        <button data-test-id="signLatestAttachmentVersion" class="btn"
            data-bind="click: sign, ltext: 'attachment.signLatest', visible: $root.authorization.ok('sign-attachments'),  enable: versions().length && $root.authorization.ok('sign-attachments')">
        </button>
      </div>

      <div class="attachment-file-conversation">
        <h3 data-bind="ltext: 'attachment.conversation'">Keskustele liitteest&auml;:</h3>
        <div data-bind="template: {name: 'comment-template', data: {comment: $root.commentsModel, mainConversation: false}}"></div>
      </div>

    </div>

  </section>
</body>
</html>
