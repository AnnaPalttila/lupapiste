<!DOCTYPE html>
<html lang="en">
<body>
  <section class="page" id="application">

    <div class="breadcrumb" data-bind="with: application">
      <a href="#!/applications" data-bind="ltext: 'requests'" data-test-id="application-requests"></a>
      <span>/</span>
      <span data-bind="text: title" data-test-id="application-title"></span>
    </div>

    <div class="application_summary">
      <div class="application-map-container">
        <div id="application-map" class="map map-large" style="width: 320px; height: 320px;"></div>
        <div class="application-map-actions" data-bind="with: application">
          <!-- ko if: location() -->
            <button data-bind="click: openOskariMap, ltext: 'application.mapActionOpen'" class="btn btn-primary map-search-button"></button>
          <!-- /ko -->
        </div>
      </div>
      <div data-bind="with: application">

        <h1 data-bind="text: address"></h1>

        <div class="application_summary_info">

          <!-- ID: -->
          <div>
            <p data-bind="ltext: 'application.id'"></p>
            <span
              data-bind="text: id, attr: {'data-test-value': id}"
              data-test-id="application-id"
              class="application_summary_text">
            </span>
          </div>

          <!-- State: -->
          <div>
            <p data-bind="ltext: 'application.state'">Tila:</p>
            <span
              data-bind="ltext: state, attr: {'data-test-state': state}"
              data-test-id="application-state"
              class="application_summary_text">
            </span>
          </div>

          <!-- Permit type: -->
          <div>
            <p data-bind="ltext: 'application.type'"></p>
            <span class="application_summary_text" data-bind="ltext: permitType"></span>
          </div>

          <!-- Property ID: -->
          <div>
            <p data-bind="ltext: 'application.property'"></p>
            <span class="application_summary_text" data-bind="text: propertyId" data-test-id="application-property-id"></span>
          </div>

          <!-- Authorities: -->
          <!-- ko if: $root.authorization.ok('assign-application') -->
          <div>
            <p data-bind="ltext: 'application.assignee'"></p>
            <span class="application_summary_text">
              <select
                data-bind="options: $root.authorities,
                           optionsText: function(item) { return item.firstName + ' ' + item.lastName; },
                           optionsValue: 'id',
                           value: $root.application.assignee,
                           optionsCaption: loc('choose')"
                data-test-id="application-assigneed-authority">
              </select>
            </span>
          </div>
          <!-- /ko -->

          <!-- Operations: -->
          <div>
            <p data-bind="ltext: 'application.operations'"></p>
            <ul data-bind="foreach: operations">
              <li>
                <span data-bind="ltext: 'operations.' + operation()" data-test-id="test-application-operation"></span>
              </li>
            </ul>
          </div>

          <!-- Submitted: -->
          <div data-bind="with: $root.applicationModel.data">
            <p data-bind="ltext: 'application.submissionDate'"></p>
            <span data-bind="if: $data.submitted">
              <span data-bind="dateString: submitted" data-test-id="application-submitted-date" class="application_summary_text"></span>
            </span>
          </div>

        </div>

        <!-- Actions: -->
        <div class="application_actions">
          <button data-bind="ltext: 'application.submitApplication',  click: submitApplication,  visible: $root.authorization.ok('submit-application'),  enable: $root.authorization.ok('submit-application')"  data-test-id="application-submit-btn"  class="btn btn-primary" ></button>
          <button data-bind="ltext: 'application.approveApplication', click: approveApplication, visible: $root.authorization.ok('approve-application'), enable: $root.authorization.ok('approve-application')" data-test-id="approve-application"     class="btn btn-primary"></button>
          <button data-bind="ltext: 'application.addOperation',       click: addOperation,       visible: $root.authorization.ok('add-operation'),       enable: $root.authorization.ok('add-operation')"                                              class="btn btn-primary"></button>
          <button data-bind="ltext: 'application.cancelApplication',  click: cancelApplication,  visible: $root.authorization.ok('cancel-application'),  enable: $root.authorization.ok('cancel-application')"  data-test-id="application-cancel-btn"  class="btn btn-primary"></button>
        </div>

        <!-- Tabs: -->
        <div class="tabs-container">
          <ul class="tabs" id="applicationTabs">
            <li><a data-bind="ltext: 'application.tabDocuments',    click: $root.application.changeTab" href="#" name="application"  data-test-id="application-open-application-tab"  ></a></li>
            <li><a data-bind="ltext: 'application.tabParties',      click: $root.application.changeTab" href="#" name="parties"      data-test-id="application-open-parties-tab"      ></a></li>
            <li><a data-bind="ltext: 'application.tabAttachments',  click: $root.application.changeTab" href="#" name="attachments"  data-test-id="application-open-attachments-tab"  ></a></li>
            <li><a data-bind="ltext: 'application.tabVerdict',      click: $root.application.changeTab" href="#" name="verdict"      data-test-id="application-open-verdict-tab"      ></a></li>
            <li><a data-bind="ltext: 'application.tabConversation', click: $root.application.changeTab" href="#" name="conversation" data-test-id="application-open-conversation-tab" ></a></li>
          </ul>
        </div>

      </div>
    </div>

    <div class="sidebar">
      <aside class="instructions">
          <h3 data-bind="ltext: 'help'">Ohje</h3>
          <p data-bind="ltext: 'application.helpText'"></p>
      </aside>
    </div>

    <div class="tab-content-container container">

      <div id="application-application-tab" class="tab-content">

        <!-- docgen generated content: -->
        <div class="application_section">
          <div id="applicationDocgen">
            <!-- This is where generated document will be placed. -->
          </div>
        </div>
      </div>

      <div id="application-parties-tab" class="tab-content">

        <div class="application_section" data-bind="with: application">
          <h2 class="application_section_header " onclick="accordion.click();">
            <span class="font-icon icon-expanded"></span> <span data-bind="ltext: 'application.basicInfo'">Hakemuksen perustiedot</span></h2>
          <div class="application_section_content content_expanded">
            <div>
              <h3 data-bind="ltext: 'application.authorizedParties'">Valtuutetut</h3>
              <div data-bind="with: $root.applicationModel">
                <ul data-bind="foreach: auth">
                  <li>
                    <span data-bind="text: firstName"></span> <span data-bind="text: lastName"></span>
                    (<span data-bind="text: username"></span>)
                    <i><span data-bind="foreach: roles"><span data-bind="text: loc($data)"></span> </span></i>
                    <span data-bind="visible: $root.application.isNotOwner($data)"><a class="remove-read" href="#" data-bind="ltext: 'remove', click: $root.application.removeAuth"></a></span>
                  </li>
                </ul>
              </div>
              <br/>
            </div>

            <h3 data-bind="if: invites"><span data-bind="ltext: 'application.invites'"></span></h3>
            <ul data-bind="foreach: invites">
              <li class="user-invite">
                <span data-bind="text: user.firstName"></span> <span data-bind="text: user.lastName"></span>
                (<span data-bind="text: user.username"></span>)
                - <span data-bind="text: text"></span>
                  <a data-test-id="application-remove-invite" href="#" data-bind="ltext: 'remove', click: $root.application.removeInvite"></a>
              </li>
            </ul>
          </div>
        </div>

        <!-- docgen generated content: -->
        <div class="application_section">
          <div id="partiesDocgen">
            <!-- This is where generated document will be placed. -->
          </div>
        </div>
      </div>

      <div id="application-conversation-tab" data-bind="with: $root.comment" class="tab-content" >
        <p data-bind="ltext: 'application.conversationDesc'" class="tab-info"></p>
        <div>
          <table class="table table-striped conversation" data-test-id="application-comments-table">
            <tbody data-bind="foreach: comments">
              <tr class="comment">
                <td class="comment-party commenttd">
                  <span class="date" data-bind="dateTimeString: created"></span>
                  <br />
                  <span class="author" data-bind="fullName: user">
                  </span>
                  <br />
                  <b>(<span class="role" data-bind="ltext: user.role"></span>)</b>
                </td>
                <td class="commenttd" data-bind="text: text"></td>
              </tr>
            </tbody>
          </table>
          <form>
            <h3 data-bind="ltext: 'application.conversationPrompt'">Kirjoita viesti:</h3>
            <textarea
              data-bind="attr: {placeholder: loc('comment.placeholder')}, value: text, valueUpdate: 'afterkeydown'"
              data-test-id="application-new-comment-text"
              class="form-input textarea"
              rows="3">
            </textarea>
            <button
              data-bind="ltext: 'application.conversationSend', disable: disabled, click: submit"
              data-test-id="application-new-comment-btn"
              type="submit"
              class="btn btn-primary"></button>
          </form>
        </div>
      </div>

      <div id="application-verdict-tab" class="tab-content" data-bind="with: application">
        <div class="tab-wrapper">
          <div class="row" data-bind="with: verdict">
            <span data-bind="text: text" data-test-id="application-verdict"></span>
          </div>
        </div>
      </div>

      <div id="application-attachments-tab" class="tab-content">
        <p data-bind="ltext: 'application.attachmentsDesc'" class="tab-info"></p>
        <div class="tab-wrapper">
          <div data-bind="if: attachmentsByGroup().length" data-test-id="application-attachments-table">

            <table class="table">
              <tbody data-bind="foreach: attachmentsByGroup">
                <tr class="attachment-group-header">
                  <td data-bind="text: loc('attachmentType.' + group + '._group_label')" colspan="6"></td>
                </tr>
                <tr>
                  <th data-bind="ltext: 'application.attachmentState'">Tila</th>
                  <th data-bind="ltext: 'application.attachmentType'">Tyyppi</th>
                  <th data-bind="ltext: 'application.attachmentFile'">Tiedosto</th>
                  <th data-bind="ltext: 'application.attachmentVersion'">Versio</th>
                  <th data-bind="ltext: 'application.attachmentEditDate'">Muokattu</th>
                  <th></th>
                </tr>

                <!-- ko foreach: attachments -->
                <tr style="cursor: pointer;">
                  <td data-bind="attr: {'class': statusName, 'data-icon': loc('attachmentState_' + state), 'data-test-state': state, 'data-test-type': type['type-group'] + '.' + type['type-id']}" class="attachment-state"></td>
                  <td data-bind="click: function() { window.location.hash='#!/attachment/' + $root.application.id() + '/' + id;}">
                    <a data-bind="attr: {href: '#!/attachment/' + $root.application.id() + '/' + id, 'data-test-type': type['type-group'] + '.' + type['type-id']}">
                      <span data-bind="if: type">
                        <span data-bind="text: loc('attachmentType.' + type['type-group'] + '.' + type['type-id'])"></span>
                      </span>
                      <span data-bind="if: !type">
                        <i data-bind="ltext: 'attachment.noName'"></i>
                      </span>
                    </a>
                  </td>
                  <td>
                    <span data-bind="if: $data.latestVersion">
                      <a href="#" data-bind="text: latestVersion.filename, attr: {href: '/api/download-attachment/' + latestVersion.fileId}"></a><br/>
                      <i data-bind="ltext: latestVersion.contentType"></i>
                      <i data-bind="size: latestVersion.size"></i>
                    </span>
                  </td>
                  <td>
                    <span data-bind="if: $data.latestVersion">
                      <span data-bind="version: latestVersion.version"></span>
                    </span>
                  </td>
                  <td>
                    <span data-bind="if: $data.latestVersion">
                    <span data-bind="dateString: modified"></span>
                      <span data-bind="fullName: latestVersion.user"></span>
                    </span>
                  </td>
                  <td>
                  </td>
                </tr>
              <!-- /ko -->

              </tbody>
            </table>

            <a data-bind="attr: {href: '/api/download-all-attachments/' + $root.application.id()}, visible: application.hasAttachment, ltext: 'download-all'" href="#" target="_blank"></a>

          </div>
          <div data-bind="ifnot: attachmentsByGroup().length">
            <i data-bind="ltext: 'application.attachmentsEmpty'" data-test-id="application-attachments-no-attachments"></i>
          </div>
          <button
              id="add-attachment"
              class="btn btn-primary modal"
              data-window-id="upload-dialog"
              data-bind="ltext: 'application.attachmentsAdd', visible: $root.authorization.ok('upload-attachment'), click: attachment.newAttachment">
          </button>
        </div>
      </div>

    </div>

    <div id="boxes">
      <div id="dialog-valtuutus" class="window autosized">
        <div class="dialog-header">
          <p data-bind="ltext: 'application.addInvite'">Lis&auml;&auml; valtuutus</p>
          <p class="dialog-close close">X</p>
        </div>
        <div class="dialog-content">
          <form data-bind="with: $root.invite">
            <label data-bind="ltext: 'userinfo.role'" class="form-label" for="invite-document"></label>
            <input class="form-input text long" id="invite-document-name" disabled="true" type="text" data-bind="value: documentName" />
            <input class="form-input text long" id="invite-document-id" disabled="true" type="hidden" data-bind="value: documentId" />
            <label data-bind="ltext: 'userinfo.email'" class="form-label" for="invite-email"></label>
            <input class="form-input text long" id="invite-email" type="text" data-bind="value: email" />
            <label data-bind="ltext: 'application.inviteMessage'" class="form-label" for="invite-text"></label>
            <textarea id="invite-text" rows=5 class="form-input textarea long" data-bind="value: text"></textarea>
            <button class="btn btn-primary btn-dialog" data-test-id="application-invite-submit" data-bind="click: submit, ltext: 'application.inviteSend'"></button>
            <h1 class="form-error" data-bind="visible: error, text: error"></h1>
          </form>
        </div>
      </div>

      <div id="dialog-remove-doc" class="window autosized">
        <div data-bind="with: $root.removeDocModel">
          <div class="dialog-header">
            <p data-bind="ltext: 'removeDoc.sure'"></p>
            <p class="dialog-close close">X</p>
          </div>
          <div class="dialog-content">
            <div>
              <span data-bind="ltext: 'removeDoc.message1'"></span>
              <strong data-bind="text: docName"></strong>
            </div>
            <div>
              <span data-bind="ltext: 'removeDoc.message2'"></span>
            </div>
            <button data-bind="click: ok, ltext: 'removeDoc.ok'" class="btn btn-primary btn-dialog close"></button>
            <button data-bind="click: cancel, ltext: 'removeDoc.cancel'" class="btn btn-dialog close"></button>
          </div>
        </div>
      </div>

    </div>
  </section>
</body>
</html>
