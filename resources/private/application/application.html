<!DOCTYPE html>
<html>
<body>
  <section class="page" id="application">
    <div class="application_summary">
      <div class="container">
        <div class="application-map-container">
          <div id="application-map" class="map map-large" style="width: 320px; height: 280px;"></div>
          <div class="application-map-actions" data-bind="with: application">
            <!-- ko if: location() -->
              <a data-bind="click: openOskariMap" class="map-search-button icon search"></a>
            <!-- /ko -->
          </div>
        </div>
        <div class="application_summary_info" data-bind="with: application">
          <h1><!-- <span data-bind="ltext: 'application.address'"></span>:  --><span data-bind="text: address" data-test-id="application-title" class="address"></span>
          <a class="icon"
             data-bind="ltext: 'edit.address', click: $root.changeLocationModel.changeLocation, visible: $root.authorization.ok('change-location')"
             data-test-id="change-location-link"></a>
          </h1>

          <!-- State: -->
          <div class="state-indication" data-bind="attr: {'data-test-state': state}" data-test-id="application-state" >
            <div data-bind="attr: {'class': state}">
              <span data-bind="ltext: 'draft', attr: {'title' : loc('draft.title')}" class="draft-box"></span>
              <span data-bind="ltext: 'open', attr: {'title' : loc('open.title')}" class="open-box"></span>
              <span data-bind="ltext: 'submitted', attr: {'title' : loc('submitted.title')}" class="submitted-box"></span>
              <span data-bind="ltext: 'complement-needed', attr: {'title' : loc('complement-needed.title')}" id="complement-needed-box" class="complement-needed-box"></span>
              <span data-bind="ltext: 'sent', attr: {'title' : loc('sent.title')}" class="sent-box"></span>
              <span data-bind="ltext: 'verdictGiven', attr: {'title' : loc('verdictGiven.title')}" class="verdictGiven-box"></span>
              <span data-bind="ltext: 'constructionStarted', attr: {'title' : loc('constructionStarted.title')}" class="constructionStarted-box"></span>
              <span data-bind="ltext: 'closed', attr: {'title' : loc('closed.title')}" class="closed-box"></span>
              <span data-bind="ltext: 'canceled', attr: {'title' : loc('canceled.title')}" class="canceled-box"></span>
            </div>
          </div>

          <!-- Property ID: -->
          <div>
            <p data-bind="ltext: 'application.property'"></p>
            <span class="application_summary_text" data-bind="propertyId: propertyId" data-test-id="application-property-id"></span>
          </div>

          <!-- Submitted: -->
          <div>
            <p data-bind="ltext: 'application.submissionDate'"></p>
            <span data-bind="if: $data.submitted">
              <span data-bind="dateString: submitted" data-test-id="application-submitted-date" class="application_summary_text"></span>
            </span>
          </div>

          <!-- ID: -->
          <div>
            <p data-bind="ltext: 'application.id'"></p>
            <span
              data-bind="text: id, attr: {'data-test-value': id}"
              data-test-id="application-id"
              class="application_summary_text">
            </span>
          </div>

          <!-- Authorities: -->
          <!-- ko if: $root.authorization.ok('assign-application') -->
          <div>
            <p data-bind="ltext: 'application.assignee'"></p>
            <span class="application_summary_text">
              <select
                data-bind="options: $root.authorities,
                           optionsText: function(item) { return item.lastName + ' ' + item.firstName; },
                           optionsValue: 'id',
                           value: $root.application.assignee,
                           optionsCaption: loc('choose')"
                data-test-id="application-assigneed-authority">
              </select>
            </span>
          </div>
          <!-- /ko -->

          <!-- Operations: -->
          <!-- ko if: $root.permitSubtypes().length == 0 -->
          <div>
            <p data-bind="ltext: 'application.operations'"></p>
            <ul data-bind="foreach: operationsCount">
              <li>
                <span data-bind="visible: count > 1">
                  <span data-bind="text: count"></span>
                  <span>&#x00D7;</span>
                </span>
                <span data-bind="ltext: 'operations.' + name, attr: {'data-test-operation-id': name}" data-test-id="test-application-operation"></span>
              </li>
            </ul>
          </div>
          <!-- /ko -->

          <!-- Subtypes: -->
          <!-- ko if: $root.permitSubtypes().length > 0 -->
          <div>
            <p data-bind="ltext: 'application.permitSubtypes'"></p>
            <span class="application_summary_text">
            <select data-bind="options: $root.permitSubtypes, value: $root.application.permitSubtype,
                               enable: $root.authorization.ok('change-permit-sub-type'),
                               optionsText: function(item) {return loc('permitSubtype.' + item); }">
            </select>
            </span>
          </div>
          <!-- /ko -->

          <!-- Link-permits: -->
          <div data-bind="with: linkPermitData">
            <p data-bind="ltext: 'application.linkPermits'"></p>
            <span class="application_summary_text" data-bind="foreach: $data">
              <span data-bind="visible: $data.type() === 'lupapistetunnus'" class="link-permit">
                <a data-bind="text: $data.id,
                              click: function(){$root.addLinkPermitModel.followAppLink($data.id())},
                              attr: {'data-test-app-link-permit': $data.id}"
                   data-test-id="test-application-link-permit-lupapistetunnus"
                   class="link-permit-item"></a>
                <a data-bind="visible: $root.authorization.ok('remove-link-permit-by-app-id'),
                              ltext: 'application.linkPermitRemoveSelected',
                              click: function(){$root.addLinkPermitModel.removeSelectedLinkPermit($root.application.id(), $data.id())}"
                   data-test-id="test-remove-link-permit"
                   href="#" class="remove-link-permit"></a>
              </span>
              <span data-bind="visible: $data.type() === 'kuntalupatunnus'" class="link-permit">
                <span data-bind="text: $data.id,
                               attr: {'data-test-app-link-permit': $data.id}"
                    data-test-id="test-application-link-permit-kuntalupatunnus"
                    class="link-permit-item">
                </span>
                <a data-bind="visible: $root.authorization.ok('remove-link-permit-by-app-id'),
                              ltext: 'application.linkPermitRemoveSelected',
                              click: function(){$root.addLinkPermitModel.removeSelectedLinkPermit($root.application.id(), $data.id())}"
                  data-test-id="test-remove-link-permit"
                  href="#" class="remove-link-permit"></a>
              </span>
            </span>
          </div>

          <!-- Applications linking to us: -->
          <!-- ko if: appsLinkingToUs -->
          <div data-bind="with: appsLinkingToUs">
            <p data-bind="ltext: 'application.appsLinkingToUs'"></p>
            <span class="application_summary_text" data-bind="foreach: $data">
              <a data-bind="text: $data.id,
                            click: function(){$root.addLinkPermitModel.followAppLink($data.id())},
                            attr: {'data-test-app-linking-to-us': $data.id}"
                 data-test-id="test-application-app-linking-to-us"
                 href="#" class="remove-link-permit"></a>
            </span>
          </div>
          <!-- /ko -->

        </div>


        <!-- Actions: -->
        <div class="application_actions" data-bind="with: application">
          <div class="muncipality-info">
            <h2 data-bind="ltext: 'application.muncipality'"></h2>
            <p data-bind="text: loc(['municipality', municipality()])"></p>
          </div>
          <!-- ko if: !showInviteButtons() -->
          <button data-bind="click: approveApplication,   visible: $root.authorization.ok('approve-application'),    enable: !processing() && $root.authorization.ok('approve-application')"    data-test-id="approve-application"     class="btn btn-primary">
            <span data-bind="ltext: 'application.approveApplication'"></span>
            <span class="icon approve left-align"></span>
          </button>
          <button data-bind="click: requestForComplement, visible: $root.authorization.ok('request-for-complement'), enable: !processing() && $root.authorization.ok('request-for-complement')" data-test-id="request-for-complement">
            <span data-bind="ltext: 'application.requestForComplement'"></span>
            <span class="icon complement left-align"></span>
          </button>
          <button data-bind="click: addOperation,         visible: $root.authorization.ok('add-operation'),          enable: !processing() && $root.authorization.ok('add-operation')"  data-test-id="add-operation">
            <span data-bind="ltext: 'application.addOperation'"></span>
            <span class="icon add-grey left-align"></span>
          </button>
          <button data-bind="click: exportPdf,            visible: $root.authorization.ok('pdf-export'),             enable: !processing() && $root.authorization.ok('pdf-export')"  data-test-id="application-pdf-btn">
            <span data-bind="ltext: 'application.pdf'"></span>
            <span class="icon print left-align"></span>
          </button>
          <button data-bind="click: $root.addLinkPermitModel.openAddLinkPermitDialog, visible: $root.authorization.ok('add-link-permit'), enable: !processing() && $root.authorization.ok('add-link-permit')"        data-test-id="application-add-link-permit-btn">
            <span data-bind="ltext: 'application.addLinkPermit'"></span>
            <span class="icon add-grey left-align"></span>
          </button>
          <button data-bind="click: createChangePermit,   visible: $root.authorization.ok('create-change-permit'),   enable: !processing() && $root.authorization.ok('create-change-permit')"     data-test-id="change-permit-create-btn"  class="btn">
            <span data-bind="ltext: 'application.createChangePermit'"></span>
            <span class="icon add-grey left-align"></span>
          </button>
          <button data-bind="click: createContinuationPeriodPermit,    visible: $root.authorization.ok('create-continuation-period-permit'), enable: !processing() && $root.authorization.ok('create-continuation-period-permit')"     data-test-id="continuation-period-create-btn"  class="btn">
            <span data-bind="ltext: 'application.createContinuationPeriodPermit'"></span>
            <span class="icon add-grey left-align"></span>
          </button>
          <button data-bind="click: cancelApplication,    visible: $root.authorization.ok('cancel-application'),     enable: !processing() && $root.authorization.ok('cancel-application')"     data-test-id="application-cancel-btn"  class="btn">
            <span data-bind="ltext: 'application.cancelApplication'"></span>
            <span class="icon remove-grey left-align"></span>
          </button>
          <button data-bind="click: refreshKTJ,           visible: $root.authorization.ok('refresh-ktj'),            enable: !processing() && $root.authorization.ok('refresh-ktj')"     data-test-id="application-refresh-ktj-btn"  class="btn">
            <span data-bind="ltext: 'application.refreshKTJ'"></span>
            <span class="icon refresh-grey left-align"></span>
          </button>
          <button data-bind="click: resetIndicators,           visible: $root.authorization.ok('mark-everything-seen'),            enable: !processing() && $root.authorization.ok('mark-everything-seen')"     data-test-id="application-mark-everything-seen-btn"  class="btn">
            <span data-bind="ltext: 'application.reset-indicators'"></span>
            <span class="icon mark-seen left-align"></span>
          </button>
          <!-- /ko  -->
          <!-- ko if: showInviteButtons -->
          <button data-bind="click: approveInvite" class="btn btn-primary btn-mini" data-test-id="accept-invite-button">
            <span data-bind="ltext: 'applications.approveInvite'"></span>
          </button>
          <button data-bind="click: declineInvite" class="btn btn-mini" data-test-id="decline-invite-button">
            <span data-bind="ltext: 'applications.declineInvite'"></span>
          </button>
          <!-- /ko -->
        </div>

        <!-- Tabs: -->
        <div class="tabs-container" data-bind="with: application">
          <ul class="tabs" id="applicationTabs">
            <li data-bind="if: !inPostVerdictState(), css: {'active': $parent.selectedTabName() === 'info'}">
              <a data-bind="click: changeTab" href="#" data-target="info" data-test-id="application-open-info-tab">
                <span data-bind="ltext: 'application.tabInfo'"></span>
                <span data-bind="if: nonpartyDocumentIndicator">
                  <span data-bind="text: nonpartyDocumentIndicator" id="applicationNonpartyDocumentIndicator" class="indicator"></span></span></a></li>

            <li data-bind="ifnot: _.contains(['closed', 'canceled'], state()), css: {'active': $parent.selectedTabName() === 'parties'}">
              <a data-bind="click: changeTab" href="#" data-target="parties" data-test-id="application-open-parties-tab">
                <span data-bind="ltext: 'application.tabParties'"></span>
                <span data-bind="if: partyDocumentIndicator">
                  <span data-bind="text: partyDocumentIndicator" id="applicationPartyDocumentIndicator" class="indicator"></span></span></a></li>

            <li data-bind="if: inPostVerdictState(), css: {'active': $parent.selectedTabName() === 'tasks'}">
              <a data-bind="click: changeTab" href="#" data-target="tasks" data-test-id="application-open-tasks-tab">
                <span data-bind="ltext: 'application.tabConstructionTimeTasks'"></span>
                <span data-bind="if: $data.tasksRequiringAction">
                  <span data-bind="text: tasksRequiringAction" id="applicationTasksRequiringAction" class="indicator"></span></span></a></li>

            <li data-bind="css: {'active': $parent.selectedTabName() === 'attachments'}">
              <a data-bind="click: changeTab" href="#" data-target="attachments" data-test-id="application-open-attachments-tab">
                <span data-bind="ltext: 'application.tabAttachments'"></span>
                <span data-bind="if: attachmentsRequiringAction">
                  <span data-bind="text: attachmentsRequiringAction" id="applicationAttachmentsRequiringAction" class="indicator"></span></span></a></li>

            <li data-bind="if: _.contains(['draft', 'open', 'submitted', 'complement-needed'], state()),
                           css: {'active': $parent.selectedTabName() === 'requiredFieldSummary'}">
              <a data-bind="click: changeTab" href="#" data-target="requiredFieldSummary" data-test-id="application-open-requiredFieldSummary-tab">
                <span data-bind="ltext: 'application.tabRequiredFieldSummary'"></span></a></li>

            <li data-bind="if: !inPostVerdictState(), css: {'active': $parent.selectedTabName() === 'statement'}">
              <a data-bind="click: changeTab" href="#" data-target="statement" data-test-id="application-open-statement-tab">
                <span data-bind="ltext: 'application.tabStatement'"></span>
                <span data-bind="if: unseenStatements">
                  <span data-bind="text: unseenStatements" id="applicationUnseenStatements" class="indicator"></span></span></a></li>

            <li data-bind="ifnot: _.contains(['draft', 'open'], state()),
                           css: {'active': $parent.selectedTabName() === 'verdict'}">
              <a data-bind="click: changeTab" href="#" data-target="verdict" data-test-id="application-open-verdict-tab">
                <span data-bind="ltext: 'application.tabVerdict'"></span>
                <span data-bind="if: unseenVerdicts">
                  <span data-bind="text: unseenVerdicts" id="applicationUnseenVerdists" class="indicator"></span></span></a></li>

            <!-- In post-verdict states plus 'canceled' -->
            <li data-bind="if: summaryAvailable(), css: {'active': $parent.selectedTabName() === 'applicationSummary'}">
              <a data-bind="click: changeTab" href="#" data-target="applicationSummary" data-test-id="application-open-applicationSummary-tab">
                <span data-bind="ltext: 'application.applicationSummary'"></span></a></li>

          </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="tab-content-container content">

        <!-- Application info tab -->

        <div id="application-info-tab" class="tab-content" data-bind="with: application">
          <h1 data-bind="ltext: 'application.tabInfo'"></h1>
          <span class="icon help" data-bind="click: function(data, event) { toggleHelp('showApplicationInfoHelp') }, css: {expanded: showApplicationInfoHelp}"></span>
          <div class="tab-info" data-bind="slider: showApplicationInfoHelp">
            <p data-bind="lhtml: 'help.' + $root.application.permitType() + '.applicationInfoDesc'"></p>
          </div>
          <div style="width: 60%">
            <div data-bind="if: $root.authorization.ok('add-operation')">
              <p data-bind="lhtml: 'help.' + $root.application.permitType() + '.AddOperations'"></p>
              <button data-bind="click: addOperation, enable: $root.authorization.ok('add-operation')" class="btn-primary">
               <span data-bind="ltext: 'application.addOperation'"></span> <span class="icon add left-align"></span>
              </button>
            </div>
            <div data-bind="if: $root.authorization.ok('link-permit-required')">
              <p data-bind="ltext: 'help.AddPermit'"></p>
              <button data-bind="click: $root.addLinkPermitModel.openAddLinkPermitDialog,
                                 enable: $root.authorization.ok('link-permit-required'),
                                 visible: $root.authorization.ok('add-link-permit')"
                      class="btn-primary">
               <span data-bind="ltext: 'application.addLinkPermit'"></span> <span class="icon add left-align"></span>
              </button>
            </div>
          </div>
          <p data-bind="lhtml: 'required.field.desc'"></p>
          <!-- docgen generated content: -->
          <div class="application_section">
            <div id="applicationDocgen" class="docgen-content">
              <!-- This is where generated document will be placed. -->
            </div>
          </div>
          <div class="process-nav">
            <a class="btn process-next btn-nav-forward" data-bind="click: $root.application.nextTab" href="#" data-target="parties">
              <span data-bind="ltext: 'application.next-tab'"></span>
              <span class="icon drill-right-orange right-align"></span>
            </a>
          </div>
        </div>

        <!-- Parties tab -->

        <div id="application-parties-tab" class="tab-content" data-bind="with: application">
          <h1 data-bind="ltext: 'application.tabParties'"></h1>
          <span class="icon help" data-bind="click: function(data, event) { toggleHelp('showPartiesInfoHelp') }, css: {expanded: showPartiesInfoHelp}"></span>
          <div class="tab-info" data-bind="slider: showPartiesInfoHelp">
            <p data-bind="lhtml: 'help.' + $root.application.permitType() + '.PartiesDesc'"></p>
            <p data-bind="lhtml: 'company-invite.help'"></p>
          </div>
          <div class="application_section">
            <div class="application_section_content content_expanded">
              <div>
                <h2 data-bind="ltext: 'application.authorizedParties'">Valtuutetut</h2>
                <div data-bind="with: $root.application" class="parties-list">
                  <ul data-bind="foreach: roles">
                    <li class="party">
                      <span class="person">
                        <span data-bind="fullName: $data"></span>
                        (<span data-bind="text: username"></span>)
                        <i><span data-bind="foreach: roles"><span data-bind="text: loc($data)"></span> </span></i>
                      </span>
                      <span class="invite-state">
                        <span data-bind="if: $data.invite">
                          <span class="user-invite" data-bind="ltext: 'invited'"></span>
                        </span>
                        <span data-bind="if: !$data.invite">
                          <span data-bind="visible: $root.application.isNotOwner($data), ltext: 'accepted'"></span>
                          <!-- ko if: $data.inviteAccepted -->
                          <span data-test-id="invite-accepted-span" data-bind="dateTimeString: $data.inviteAccepted"></span>
                          <!-- /ko -->
                        </span>
                      </span>
                      <a class="invite-action" href="#" data-bind="ltext: 'application.remove-auth', click: $root.application.removeAuth, visible: $root.application.isNotOwner($data)"></a>
                      <!-- ko if: $root.application.canSubscribe($data) -->
                      <a class="invite-action" href="#" data-bind="visible: $data.unsubscribed && $data.unsubscribed(), click: $root.application.subscribeNotifications, ltext: 'subscribeNotifications'"></a>
                      <a class="invite-action" href="#" data-bind="visible: !$data.unsubscribed || !$data.unsubscribed(), click: $root.application.unsubscribeNotifications, ltext: 'unsubscribeNotifications'"></a>
                      <!-- /ko -->
                    </li>
                  </ul>

                  <button class="btn-primary"
                        data-test-id="application-invite-person"
                        data-bind="ltext: 'personSelector.invite',
                                   visible: $root.authorization.ok('invite-with-role'),
                                   enabled: $root.authorization.ok('invite-with-role')"
                        onclick="$('#invite-document-name').val('').change();$('#invite-document-path').val('').change();$('#invite-document-id').val('').change();LUPAPISTE.ModalDialog.open('#dialog-valtuutus');return false;">
                  </button>
                  <button class="btn-primary"
                        data-test-id="company-invite"
                        data-bind="ltext: 'company-invite.invite',
                                   visible: $root.authorization.ok('invite-with-role'),
                                   enabled: $root.authorization.ok('invite-with-role'),
                                   click: $root.openInviteCompany">
                  </button>
                </div>
              </div>
            </div>
          </div>
          <p data-bind="lhtml: 'required.field.desc'"></p>
          <!-- ko if: $root.application.permitType() === "R" -->
          <div data-bind="if: features.enabled('foreman')">
            <div class="feature">
              <span class="legend">Tyonjohtajan nimeaminen</span>
              <section class="accordion" id="accordion-application-foreman">
                <h2 onclick="accordion.click(this)" data-test-id="accordion-application-foreman-header">
                  <span class="icon toggle-icon drill-down-white"></span>
                  <span data-bind="ltext: 'application.parties.foreman'"></span>
                </h2>
                <div class="accordion_content expanded" data-accordion-state="open">
                  <div class="accordion-fields">
                    <div data-bind="template: {name: 'application-foreman-template', data: $root.foreman}"></div>
                  </div>
                </div>
              </section>
            </div>
          </div>
          <!-- /ko -->

          <!-- docgen generated content: -->
          <div class="application_section">
            <div id="partiesDocgen" class="docgen-content">
              <!-- This is where generated document will be placed. -->
            </div>
          </div>

          <button
              data-bind="click: $parent.addPartyModel.init, ltext: 'application.addParty', visible: $parent.authorization.ok('create-doc')"
              class="btn btn-primary modal"
              data-test-id="add-party">
          </button>

          <div class="process-nav">
            <a class="btn process-next btn-nav-forward" data-bind="click: $root.application.nextTab" href="#" data-target="attachments">
              <span data-bind="ltext: 'application.next-tab'"></span>
              <span class="icon drill-right-orange right-align"></span>
            </a>
            <a class="btn process-previous btn-nav-back" data-bind="click: $root.application.nextTab" href="#" data-target="info">
              <span data-bind="ltext: 'application.previous-tab'"></span>
              <span class="icon drill-left-black-bigger left-align"></span>
            </a>
          </div>
        </div>

        <!-- Attachments tab -->

        <div id="application-attachments-tab" class="tab-content" data-bind="with: $root.attachmentsTab">
          <h1 data-bind="ltext: 'application.tabAttachments'"></h1>
          <span class="icon help" data-bind="click: toggleHelp, css: {expanded: showHelp}"></span>
          <div class="tab-info" data-bind="slider: showHelp">
            <p data-bind="lhtml: 'help.' + $root.application.permitType() + '.attachmentsDesc'"></p>
          </div>
          <div class="clear"></div>
          <div class="attachment-legend">
            <span class="ok icon"></span>
            <span data-bind="ltext: 'ok.title'"></span>
          </div>
          <div class="attachment-legend">
            <span class="new icon"></span>
            <span data-bind="ltext: 'new.title'"></span>
          </div>
          <div class="attachment-legend">
            <span class="missing icon"></span>
            <span data-bind="ltext: 'missing.title'"></span>
          </div>
          <div class="attachment-legend">
            <span class="icon signed"></span>
            <span data-bind="ltext: 'attachment.signed'"></span>
          </div>
          <div class="attachment-legend">
            <span class="icon transfered"></span>
            <span data-bind="ltext: 'application.attachmentSentDate'"></span>
          </div>
          <div class="attachment-legend">
            <span class="icon stamped"></span>
            <span data-bind="ltext: 'attachment.stamped'"></span>
          </div>


          <div data-bind="if: preAttachmentsByOperation().length == 0 && postAttachmentsByOperation().length == 0">
            <i data-bind="ltext: 'application.attachmentsEmpty'" data-test-id="application-attachments-no-attachments"></i>
          </div>

          <div class="attachment-actions" data-bind="visible: (!$root.application.inPostVerdictState() && preAttachmentsByOperation().length > 0) || ($root.application.inPostVerdictState() && postAttachmentsByOperation().length > 0), template: {name: 'attachment-actions-template'}"></div>

          <div>
            <div data-bind="if: postAttachmentsByOperation().length > 0" data-test-id="application-post-attachments-table">
              <h1><span data-bind="ltext: 'application.attachments.post-verdict'"></span></h1>
              <div class="clear" data-bind="template: {name: 'attachments-template-op', data: postAttachmentsByOperation()}"></div>
            </div>
            <!-- ko if: !$root.application.inPostVerdictState() -->
            <div data-bind="if: preAttachmentsByOperation().length > 0" data-test-id="application-pre-attachments-table">
              <div class="clear" data-bind="template: {name: 'attachments-template-op', data: preAttachmentsByOperation()}"></div>
            </div>
            <!-- /ko -->

            <div class="attachment-actions" data-bind="template: {name: 'attachment-actions-template'}"></div>

            <!-- ko if: $root.application.inPostVerdictState() -->
            <div data-bind="if: preAttachmentsByOperation().length > 0" data-test-id="application-pre-attachments-table">
              <h1><span data-bind="ltext: 'application.attachments.pre-verdict'"></span></h1>
              <div class="clear" data-bind="template: {name: 'attachments-template-op', data: preAttachmentsByOperation()}"></div>
            </div>
            <!-- /ko -->

            <a data-bind="attr: {href: '/api/raw/download-all-attachments?id=' + $root.application.id() + '&lang=' + loc.getCurrentLanguage() }, visible: $root.application.hasAttachment, ltext: 'download-all'" data-test-id="application-download-all-attachement" href="#" target="_blank"></a>

          </div>

          <div class="process-nav">
            <a class="btn process-next btn-nav-forward" data-bind="click: $root.application.nextTab" href="#" data-target="requiredFieldSummary">
              <span data-bind="ltext: 'application.next-tab'"></span>
              <span class="icon drill-right-orange right-align"></span>
            </a>
            <a class="btn process-previous btn-nav-back" data-bind="click: $root.application.nextTab" href="#" data-target="parties">
              <span data-bind="ltext: 'application.previous-tab'"></span>
              <span class="icon drill-left-black-bigger left-align"></span>
            </a>
          </div>
        </div>

        <!-- Required field summary tab -->

        <div id="application-requiredFieldSummary-tab" data-bind="with: $root.application" class="tab-content">
          <div>
            <h1 data-bind="ltext: 'application.tabRequiredFieldSummary'"></h1>

            <div class="clear spacerM"></div>

            <!--  ko if:  !hasIncorrectlyFilledRequiredFields() -->
              <h2 data-bind="ltext: 'application.allRequiredDataFilled'"></h2>
              <button class="btn btn-primary"
                       data-test-id="application-submit-btn"
                       data-bind="click: submitApplication,
                                  visible: $root.authorization.ok('submit-application'),
                                  enable: !processing() && !showInviteButtons() && (!requiredFieldsFillingObligatory() || !hasIncorrectlyFilledRequiredFields())">
                 <span data-bind="ltext: 'application.submitApplication'"></span>
                 <span class="icon send left-align"></span>
               </button>
            <!-- /ko -->

            <!--  ko if:  hasIncorrectlyFilledRequiredFields -->
              <h2 data-bind="ltext: 'application.requiredDataMissing'"></h2>
              <i class="error-text" data-bind="ltext: 'application.requiredDataDesc', visible: requiredFieldsFillingObligatory() && hasIncorrectlyFilledRequiredFields()"></i><br>
              <button class="btn btn-primary"
                       data-test-id="application-submit-btn"
                       data-bind="click: submitApplication,
                                  visible: $root.authorization.ok('submit-application'),
                                  enable: !processing() && !showInviteButtons() && (!requiredFieldsFillingObligatory() || !hasIncorrectlyFilledRequiredFields())">
                 <span data-bind="ltext: 'application.submitApplication'"></span>
                 <span class="icon send left-align"></span>
               </button>
                <!-- ko foreach: incorrectlyFilledRequiredFields -->
                  <div data-bind="with: $data[0]">
                    <h3 class="required-field-error-doc" data-bind="ltext: document.name + '._group_label'"></h3>
                  </div>
                  <!-- ko foreach: $data -->
                  <div class="requiredField-line">
                    <span class="missing icon"></span>
                    <span class="required-field-error-element-name" data-bind="ltext: element.locKey"></span>
                    <a data-bind="click: $root.application.moveToIncorrectlyFilledRequiredField, ltext: 'view'" href="#"></a>
                  </div>
                  <!-- /ko -->
                <!-- /ko -->
            <!-- /ko -->
          </div>

          <div class="process-nav">
            <a class="btn process-previous btn-nav-back" data-bind="click: $root.application.nextTab" href="#" data-target="attachments">
              <span data-bind="ltext: 'application.previous-tab'"></span>
              <span class="icon drill-left-black-bigger left-align"></span>
            </a>
          </div>
        </div>

        <!-- Application summary tab -->

        <div id="application-applicationSummary-tab" data-bind="with: $root.application" class="tab-content" >

          <h1 data-bind="ltext: 'application.tabApplicationSummary'"></h1>
          <span class="icon help" data-bind="click: function(data, event) { toggleHelp('showSummaryInfoHelp') }, css: {expanded: showSummaryInfoHelp}"></span>
          <div class="tab-info" data-bind="slider: showSummaryInfoHelp">
            <p data-bind="lhtml: 'help.' + $root.application.permitType() + '.applicationSummaryDesc'"></p>
          </div>
          <div class="application_section">
            <div id="applicationAndPartiesDocgen" class="docgen-content">
              <!-- This is where the generated documents will be placed. -->
            </div>
          </div>

          <section class="accordion" id="accordion-application-summary-statements">
            <h2 onclick="accordion.click(this)" data-test-id="accordion-application-summary-statements-header">
              <span class="icon toggle-icon drill-right-white"></span>
              <span data-bind="ltext: 'application.statements'" style="margin-right: 0">Lausunnot</span>
            </h2>
            <div class="accordion_content" data-accordion-state="closed">
              <div class="accordion-fields">
                <div data-bind="template: {name: 'statements-template', data: {statements: $data.statements, localisationKeys: {missing: 'application.statement.missing-from-prev-permit'}}}"></div>
              </div>
            </div>
          </section>

          <section class="accordion">
            <h2 onclick="accordion.click(this)">
              <span class="icon toggle-icon drill-right-white"></span>
              <span data-bind="lhtml: 'application.neighbors.hearings'" style="margin-right: 0">Kuulemiset</span>
            </h2>
            <div class="accordion_content" data-accordion-state="closed">
              <div class="accordion-fields">
                <div data-bind="template: {name: 'neighbors-template', data: {neighbors: $data.neighbors, localisationKeys: {missing: 'neighbors.missing-from-prev-permit'}}}"></div>
              </div>
            </div>
          </section>

          <div class="process-nav">
            <a class="btn process-previous btn-nav-back" data-bind="click: $root.application.nextTab" href="#" data-target="attachments">
              <span data-bind="ltext: 'application.previous-tab'"></span>
              <span class="icon drill-left-black-bigger left-align"></span>
            </a>
          </div>

        </div>

        <!-- Verdict tab -->

        <div id="application-verdict-tab" class="tab-content">
          <h1 data-bind="ltext: 'application.tabVerdict'"></h1>
          <span class="icon help" data-bind="click: function(data, event) { application.toggleHelp('showVerdictInfoHelp') }, css: {expanded: application.showVerdictInfoHelp}"></span>
          <div class="tab-info" data-bind="slider: application.showVerdictInfoHelp">
            <p data-bind="lhtml: 'help.' + $root.application.permitType() + '.verdictDesc'"></p>
          </div>
          <div data-bind="if: $root.verdictModel.verdicts()">
            <div class="application_section" data-bind="foreach: $root.verdictModel.verdicts">

              <h2 class="application_section_header">
                <span data-bind="ltext: 'verdict.id'"></span>:
                <span data-bind="text: $data.kuntalupatunnus, attr: {'data-test-id' : 'given-verdict-id-' + $index()}"></span>
                <span data-bind="visible: $data.draft" style="text-transform: lowercase;">(<span data-bind="ltext: 'draft'"></span>)</span>

                <span class="icon remove-grey"
                      data-bind="click: $root.verdictModel.deleteVerdict,
                                 visible: $root.authorization.ok('delete-verdict'),
                                 enable: $root.authorization.ok('delete-verdict'),
                                 attr: {'title': loc('remove')}"></span>
              </h2>

              <!--  ko if:  $data.paatokset -->
              <div data-bind="foreach: paatokset, attr: {'data-test-id' : 'given-verdict-id-' + $index() + '-content'}">
                <div class="accordion">
                  <h2 onclick="accordion.click(this)">
                    <span class="icon toggle-icon drill-down-white"></span>
                    <span data-bind="ltext: 'application.verdict.title'" style="margin-right: 0"></span>
                    <span data-bind="text: $index() + 1"></span>
                  </h2>
                  <div class="accordion_content expanded">

                    <div data-bind="with: $parent" style="overflow: auto;">
                      <div class="btn-container right-align"  data-bind="if: $data.draft" >
                        <button data-bind="visible: $root.authorization.ok('save-verdict-draft'), click: function() {$root.verdictModel.openVerdict($root, $data);}, ltext: 'edit'"
                                class="btn btn-primary" data-test-id="edit-verdict"></button>
                        <button data-bind="visible: $root.authorization.ok('publish-verdict'), click: function() {$root.verdictModel.publishVerdict($root, $data);}, ltext: 'verdict.submit'"
                                class="btn btn-primary" data-test-id="publish-verdict"></button>
                      </div>
                    </div>

                    <div class="accordion-fields">
                      <div class="verdict-info-fields">
                        <div class="verdict-signature-fields" data-bind="visible: !$parent.draft">
                          <h3 data-bind="ltext: 'verdict.signatures'"></h3>

                          <div data-bind="foreach: $data.signatures">
                            <div data-test-id="verdict-signature-listing">
                              <label data-bind="fullName: $data.user"></label>
                              <span class="value" data-bind="dateString: created"></span>
                            </div>
                          </div>

                          <div data-bind="if: $root.authorization.ok('sign-verdict') && !$root.verdictModel.verdictSignedByUser($data)" data-test-id="verdict-signature-ui">
                            <span data-bind="ltext: 'verdict.signature.description'"></span>
                            <br/>
                            <button class="btn btn-primary" data-bind="click: $root.verdictModel.openSigningDialog, ltext: 'verdict.sign'" data-test-id="sign-verdict-button"></button>
                          </div>
                        </div>

                        <div data-bind="if: $data.paivamaarat">
                          <div data-bind="if: paivamaarat.anto" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.anto'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.anto"></span>
                          </div>
                          <div data-bind="if: paivamaarat.paatosdokumentinPvm" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.paatosdokumentinPvm'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.paatosdokumentinPvm"></span>
                          </div>
                          <div data-bind="if: paivamaarat.julkipano" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.julkipano'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.julkipano"></span>
                          </div>
                          <div data-bind="if: paivamaarat.viimeinenValitus" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.viimeinenValitus'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.viimeinenValitus"></span>
                          </div>
                          <div data-bind="if: paivamaarat.lainvoimainen" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.lainvoimainen'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.lainvoimainen"></span>
                          </div>
                          <div data-bind="if: paivamaarat.aloitettava" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.aloitettava'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.aloitettava"></span>
                          </div>
                          <div data-bind="if: paivamaarat.voimassaHetki" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.voimassaHetki'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.voimassaHetki"></span>
                          </div>
                          <div data-bind="if: paivamaarat.raukeamis" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.raukeamis'"></label>
                            <span class="value" data-bind="dateString: paivamaarat.raukeamis"></span>
                          </div>
                        </div>
                      </div>

                      <div>
                        <h2 data-bind="ltext: 'verdict.lupamaaraukset'"></h2>
                        <div class="accordion-content-part">

                          <!--  ko if:  $data.lupamaaraykset -->
                          <div data-bind="if: lupamaaraykset.autopaikkojaEnintaan" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.autopaikkojaEnintaan'"></label><span class="value" data-bind="text: lupamaaraykset.autopaikkojaEnintaan"></span></div>
                          <div data-bind="if: lupamaaraykset.autopaikkojaVahintaan" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.autopaikkojaVahintaan'"></label><span class="value" data-bind="text: lupamaaraykset.autopaikkojaVahintaan"></span></div>
                          <div data-bind="if: lupamaaraykset.autopaikkojaRakennettava" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.autopaikkojaRakennettava'"></label><span class="value" data-bind="text: lupamaaraykset.autopaikkojaRakennettava"></span></div>
                          <div data-bind="if: lupamaaraykset.autopaikkojaRakennettu" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.autopaikkojaRakennettu'"></label><span class="value" data-bind="text: lupamaaraykset.autopaikkojaRakennettu"></span></div>
                          <div data-bind="if: lupamaaraykset.autopaikkojaKiinteistolla" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.autopaikkojaKiinteistolla'"></label><span class="value" data-bind="text: lupamaaraykset.autopaikkojaKiinteistolla"></span></div>
                          <div data-bind="if: lupamaaraykset.autopaikkojaUlkopuolella" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.autopaikkojaUlkopuolella'"></label><span class="value" data-bind="text: lupamaaraykset.autopaikkojaUlkopuolella"></span></div>
                          <div data-bind="if: lupamaaraykset.kerrosala" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.kerrosala'"></label><span class="value" data-bind="text: lupamaaraykset.kerrosala"></span></div>
                          <div data-bind="if: lupamaaraykset.kokonaisala" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.kokonaisala'"></label><span class="value" data-bind="text: lupamaaraykset.kokonaisala"></span></div>

                          <div data-bind="if: lupamaaraykset.vaaditutTyonjohtajat && lupamaaraykset.vaaditutTyonjohtajat.length" class="key-value-pair">
                            <h3 data-bind="ltext: 'verdict.vaaditutTyonjohtajat'"></h3>
                            <span class="value" data-bind="text: lupamaaraykset.vaaditutTyonjohtajat"></span>
                          </div>

                          <div data-bind="if: lupamaaraykset.muutMaaraykset && lupamaaraykset.muutMaaraykset.length" class="key-value-pair">
                            <label data-bind="ltext: 'verdict.muutMaaraykset'"></label>
                            <ul data-bind="foreach: lupamaaraykset.muutMaaraykset">
                              <li data-bind='text: $data'></li>
                            </ul>
                          </div>

                          <div data-bind='if: lupamaaraykset.vaaditutKatselmukset && lupamaaraykset.vaaditutKatselmukset.length'>
                            <h3 data-bind="ltext: 'verdict.vaaditutKatselmukset'"></h3>
                            <ul data-bind="foreach: lupamaaraykset.vaaditutKatselmukset">
                              <li data-bind='if: $data.katselmuksenLaji'>
                                <span data-bind="ltext: 'task-katselmus.katselmuksenLaji.'+ $data.katselmuksenLaji"></span>
                                <span data-bind="if: $data.tarkastuksenTaiKatselmuksenNimi">
                                  (<span data-bind="text: $data.tarkastuksenTaiKatselmuksenNimi"></span>)
                                </span>
                              </li>
                            </ul>
                          </div>

                          <div data-bind='if: lupamaaraykset.maaraykset && lupamaaraykset.maaraykset.length'>
                            <h3 data-bind="ltext: 'verdict.maaraykset'"></h3>
                            <table class="table table-striped tablesorter">
                              <thead>
                                <tr>
                                  <th data-bind="ltext: 'verdict.maaraykset.maaraysaika'" style="width: 25%"></th>
                                  <!-- <th data-bind="ltext: 'verdict.maaraykset.toteutusHetki'"></th> -->
                                  <th data-bind="ltext: 'verdict.maaraykset.sisalto'"></th>
                                </tr>
                              </thead>
                              <tbody data-bind="foreach: lupamaaraykset.maaraykset">
                                <tr>
                                  <td data-bind='dateString: $data.maaraysaika'></td>
                                  <!-- <td data-bind='dateString: toteutusHetki'></td> -->
                                  <td data-bind='text: $data.sisalto'></td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                          <!-- /ko --> <!-- /lupamaaraykset -->

                          <!--  ko ifnot:  $data.lupamaaraykset -->
                          <div data-bind="ltext: 'verdict.lupamaaraukset.missing'"></div>
                          <!-- /ko -->

                        </div>

                        <h2 data-bind="ltext: 'verdict.poytakirjat'"></h2>
                        <div class="accordion-content-part">

                          <!--  ko if:  $data.poytakirjat && $data.poytakirjat.length -->
                          <table class="table table-striped tablesorter" id="application-verdict-details">
                            <thead>
                              <tr>
                                <th data-bind="ltext: 'verdict.status'" colspan="2"></th>
                                <th data-bind="ltext: 'verdict.pykala'"></th>
                                <th data-bind="ltext: 'verdict.name'"></th>
                                <th data-bind="ltext: 'verdict.paatospvm'"></th>
                                <th data-bind="ltext: 'verdict.attachments'"></th>
                              </tr>
                            </thead>
                            <tbody data-bind="foreach: $data.poytakirjat">
                              <tr class="statement-row">
                                <td data-bind="if: $data.status">
                                  <span data-bind="ltext: 'verdict.status.'+$data.status"></span></td>
                                <td data-bind="text: $data.paatos" class="verdict-text"></td>
                                <td data-bind="text: $data.pykala"></td>
                                <td data-bind="text: $data.paatoksentekija"></td>
                                <td data-bind="dateString: $data.paatospvm"></td>
                                <td data-bind="foreach: $data.attachments">
                                  <span data-bind="with: $data.latestVersion">
                                    <a href="#" data-bind="text: filename, attr: {href: '/api/raw/download-attachment?attachment-id=' + fileId}"></a><br/>
                                      <i data-bind="ltext: contentType"></i>
                                      <i data-bind="size: size"></i><br/>
                                  </span>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                          <!-- /ko --> <!-- /poytakirjat -->

                          <!--  ko ifnot:  $data.poytakirjat && $data.poytakirjat.length -->
                          <div data-bind="ltext: 'verdict.poytakirjat.missing'"></div>
                          <!-- /ko -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /ko --> <!-- /paatokset -->

            </div>
          </div>

          <button
            data-bind="click: $root.verdictModel.newVerdict, visible: $root.authorization.ok('new-verdict-draft'), disable: $root.verdictModel.newProcessing"
            class="btn btn-primary modal"
            data-test-id="give-verdict">
            <em data-bind="visible: $root.verdictModel.newPending" class="button-loader"></em>
            <span data-bind="ltext: 'application.verdict.add'"></span>
          </button>

          <button
            data-bind="click: $root.verdictModel.checkVerdict, disable: $root.verdictModel.processing, visible: $root.authorization.ok('check-for-verdict')"
            class="btn btn-primary modal"
            data-test-id="fetch-verdict">
            <em data-bind="visible: $root.verdictModel.pending" class="button-loader"></em>
            <span data-bind="ltext: 'verdict.fetch.button'"></span>
          </button>
        </div>

        <!-- Statement tab -->

        <div id="application-statement-tab" class="tab-content">

          <div data-bind="with: application" class="application-statements">
            <h1 data-bind="ltext: 'application.statements'">Lausunnot</h1>
            <span class="icon help" data-bind="click: function(data, event) { toggleHelp('showStatementsInfoHelp') }, css: {expanded: showStatementsInfoHelp}"></span>
            <div class="tab-info" data-bind="slider: showStatementsInfoHelp">
              <p data-bind="lhtml: 'help.' + permitType() + '.statementsDesc'"></p>
            </div>
            <div data-bind="template: {name: 'statements-template', data: {statements: $data.statements, localisationKeys: {missing: 'application.statement.missing'}}}"></div>
            <button data-bind="click: $root.requestForStatementModel.openDialog, ltext: 'application.statement.add', visible: $root.authorization.ok('request-for-statement')"
                    class="btn btn-primary modal"
                    data-test-id="add-statement">
            </button>
          </div>

          <div data-bind="with: application" class="application-neighbors">

            <h1 data-bind="lhtml: 'application.' + $root.application.permitType() + '.neighbors'">Naapurit</h1>
            <span class="icon help" data-bind="click: function(data, event) { toggleHelp('showNeighborsInfoHelp') }, css: {expanded: showNeighborsInfoHelp}"></span>
            <div class="tab-info" data-bind="slider: showNeighborsInfoHelp">
              <p data-bind="lhtml: 'help.' + $root.application.permitType() + '.neighborsDesc'"></p>
            </div>
            <div data-bind="template: {name: 'neighbors-template', data: {neighbors: $data.neighbors, localisationKeys: {missing: 'neighbors.missing'}}}"></div>

            <button data-bind="click: $root.neighbor.manage, ltext: 'neighbors.manage', visible: $root.authorization.ok('neighbor-add')" class="btn btn-primary modal" data-test-id="manage-neighbors"></button>
          </div>
        </div>

        <script type="text/html" id="statements-template">
          <div data-bind="ifnot: $data.statements && statements().length > 0">
            <p data-bind="ltext: $data.localisationKeys.missing" data-test-id="application-no-statements"></p>
          </div>

          <div data-bind="if: $data.statements && statements().length > 0">
            <table class="table table-striped tablesorter" data-test-id="application-statements">
              <thead>
                <tr>
                  <th data-bind="ltext: 'application.statement.desc'"></th>
                  <th data-bind="ltext: 'auth-admin.statement-person.name'"></th>
                  <th data-bind="ltext: 'application.statement.requested'"></th>
                  <th data-bind="ltext: 'application.statement.given'"></th>
                  <th data-bind="ltext: 'application.statement.status'"></th>
                </tr>
              </thead>
              <tbody data-bind="foreach: $data.statements()">
                <tr class="statement-row">
                  <td>
                    <span data-bind="if: status() || $root.authorization.ok('should-see-unsubmitted-statements')">
                      <a href="#" data-bind="text: person.text, click: $root.requestForStatementModel.openStatement, attr: {'data-test-id' : 'open-statement-' + $index()}"></a>
                    </span>
                    <span data-bind="ifnot: status() || $root.authorization.ok('should-see-unsubmitted-statements')">
                      <span data-bind="text: person.text, attr: {'data-test-id' : 'open-statement-' + $index()}"></span>
                    </span>
                  </td>
                  <td data-bind="text: person.name"></td>
                  <td data-bind="dateString: requested"></td>
                  <td data-bind="dateString: given"></td>
                  <td data-bind="text: status() && loc(['statement', status()]), attr: {'data-test-name' : person.name}"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </script>

        <script type="text/html" id="neighbors-template">
          <div data-bind="ifnot: neighbors() && neighbors().length > 0">
            <p data-bind="ltext: $data.localisationKeys.missing" data-test-id="application-no-neigbors"></p>
          </div>

          <div data-bind="if: neighbors() && neighbors().length > 0">
            <table>
              <thead>
                <tr>
                  <th data-bind="ltext: 'neighbors.propertyId'"></th>
                  <th data-bind="ltext: 'neighbors.owner'"></th>
                  <th data-bind="ltext: 'neighbors.status'"></th>
                  <th data-bind="ltext: 'neighbors.actions'"></th>
                </tr>
              </thead>
              <tbody data-bind="foreach: neighbors">
                <tr data-bind="attr: {'data-test-id': 'neighbors-row-email-' + owner.email()}">
                  <td data-bind="propertyId: propertyId"></td>
                  <td data-bind="with: owner">
                    <span data-bind="text: name" class="owner-name"></span>
                    <span data-bind="text: address.street" class="owner-street"></span>
                    <span data-bind="text: address.zip" class="owner-zip"></span>
                    <span data-bind="text: address.city" class="owner-city"></span>
                    <span data-bind="text: email" class="owner-email"></span>
                  </td>
                  <td>
                    <a data-bind="visible: $root.neighbor.statusCompleted($data),
                                  click: $root.neighbor.showStatus,
                                  attr: {'data-test-id': 'neighbors-row-status-' + _.last(status()).state()}"
                       href="#">
                      <span data-bind="text: loc(['neighbor.state', _.last(status()).state()])" class="status-state"></span>
                    </a>
                    <span data-bind="visible: !$root.neighbor.statusCompleted($data),
                                     text: loc(['neighbor.state', _.last(status()).state()]),
                                     attr: {'data-test-id': 'neighbors-row-status-' + _.last(status()).state()}"
                          class="status-state">
                    </span>
                    <span data-bind="dateTimeString: _.last(status()).created()" class="status-time"></span>
                  </td>
                  <td>
                    <span data-bind="visible: !$root.neighbor.statusCompleted($data)">
                      <a data-bind="click: $root.sendNeighborEmailModel.open,
                                    visible: $root.authorization.ok('neighbor-send-invite'),
                                    ltext: 'neighbors.actions.sendEmail'"
                         data-test-id="neighbor-row-invite"
                         class="command"
                         href="#">
                      </a>
                      <a data-bind="click: $root.neighbor.markDone,
                                    visible: _.last(status()).state() != 'mark-done' && $root.authorization.ok('neighbor-mark-done'),
                                    ltext: 'neighbors.actions.markDone',
                                    clickBubble: false"
                         data-test-id="neighbor-row-mark-done"
                         class="command"
                         href="#">
                       </a>
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </script>

        <!-- Tasks tab -->

        <div id="application-tasks-tab" data-bind="with: $root.application" class="tab-content" >

          <h1 data-bind="ltext: 'application.tabConstructionTimeTasks'"></h1>
          <span class="icon help" data-bind="click: function(data, event) { toggleHelp('showConstructionInfoHelp') }, css: { expanded: showConstructionInfoHelp }"></span>
          <div class="tab-info" data-bind="slider: showConstructionInfoHelp">
            <p data-bind="lhtml: 'help.' + permitType() + '.tasksDesc'"></p>
          </div>
          <div data-bind="if: buildings() && buildings().length > 0 && $root.authorization.ok('inform-building-construction-started')">

            <table>
              <thead>
                <tr><td colspan="4"><h2 data-bind="ltext: 'application.aloitusilmoitukset'" style="padding-top:0.5em"></h2></td></tr>
                <tr>
                  <th data-bind="ltext: 'application.buildingStatus'"></th>
                  <th data-bind="ltext: 'application.buildingOperation'"></th>
                  <th data-bind="ltext: 'application.buildingStartedDate'"></th>
                  <th data-bind="ltext: 'application.buildingStartedBy'"></th>
                </tr>
              </thead>
              <tbody data-bind="foreach: buildings">
                <tr>
                  <td><span data-bind="attr: {'class': ($data.constructionStarted ? 'ok': 'missing')  + ' icon'}"></span></td>
                  <td data-bind="text: util.buildingName($data)"></td>
                  <td>
                    <span data-bind="if: !$data.constructionStarted">
                      <a data-bind="click: $root.constructionStateChangeModel.openBuildingConstructionStartDialog, ltext: 'application.beginConstructionOf'" href="#"></a>
                    </span>
                    <span data-bind="if: $data.constructionStarted">
                      <span data-bind="dateString: $data.constructionStarted"></span>
                    </span>
                  </td>
                  <td data-bind="fullName: $data.startedBy"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- YA: Info about construction started and construction ready occasions -->
          <div data-bind="if: $root.authorization.ok('inform-construction-started') || _.contains(['constructionStarted', 'closed'], $data.state())">
            <table>
              <thead>
                <tr><td colspan="4"><h2 data-bind="ltext: 'application.aloitusjavalmistumisilmoitukset'" style="padding-top:0.5em"></h2></td></tr>
                <tr>
                  <th data-bind="ltext: 'application.constructionStateChangeOperation'"></th>
                  <th data-bind="ltext: 'application.constructionStateChangeDate'"></th>
                  <th data-bind="ltext: 'application.constructionStateChangedBy'"></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>

                <!-- Hanke aloitettu -->
                <tr>
                  <td><span data-bind="ltext: 'constructionStarted'"></span></td>
                  <td>
                    <span data-bind="if: $data.started">
                      <span data-bind="dateString: $data.started"
                            data-test-id="construction-state-change-info-started"></span>
                    </span>
                  </td>
                  <td data-bind="fullName: $data.startedBy"></td>
                  <td>
                    <button class="btn btn-primary"
                            data-test-id="application-inform-construction-started-btn"
                            data-bind="click: $root.constructionStateChangeModel.openConstructionStartDialog,
                                       ltext: 'application.button.informConstructionStarted',
                                       visible: $root.authorization.ok('inform-construction-started'),
                                       enable: $root.authorization.ok('inform-construction-started')"></button>
                  </td>
                </tr>

                <!-- Hanke valmistunut -->
                <tr>
                  <td><span data-bind="ltext: 'closed'"></span></td>
                  <td>
                    <span data-bind="if: $data.closed">
                      <span data-bind="dateString: $data.closed"
                            data-test-id="construction-state-change-info-closed"></span>
                    </span>
                  </td>
                  <td data-bind="fullName: $data.closedBy"></td>
                  <td>
                    <button class="btn btn-primary"
                            data-test-id="application-inform-construction-ready-btn"
                            data-bind="click: $root.constructionStateChangeModel.openConstructionReadyDialog,
                                       ltext: 'application.button.informConstructionReady',
                                       visible: $root.authorization.ok('inform-construction-ready'),
                                       enable: $root.authorization.ok('inform-construction-ready')"></button>
                  </td>
                </tr>

              </tbody>
            </table>
          </div>

          <div data-bind="if: features.enabled('foreman')">
            <div class="feature">
              <span class="legend">Tyonjohtajan nimeaminen</span>
              <div data-bind="template: {name: 'application-foreman-tasks-template', data: $root.foreman}"></div>
            </div>
          </div>

          <div>
            <table data-bind="foreach: taskGroups" class="tasks">
              <thead>
                <tr><td colspan="3"><h2 data-bind="text: name" style="padding-top:1em"></h2></td></tr>
                <tr>
                  <th data-bind="ltext: 'application.taskState'"></th>
                  <th data-bind="ltext: 'application.taskDisplayName'"></th>
                  <th data-bind="ltext: 'application.taskClosed'"></th>
                </tr>
              </thead>
              <tbody data-bind="foreach: tasks">
                <tr data-bind="attr: {'data-test-type': schema.info.name}">
                  <td><span data-bind="attr: {'class': statusName + ' icon', 'data-test-state': $data.state, 'title': loc(['task', statusName, 'title'])}"></span></td>
                  <td><a href="#" data-bind="click: openTask, text: displayName"></a></td>
                  <td data-bind="dateString: $data.closed"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <button class="btn btn-primary"
                  data-test-id="application-new-task"
                  data-bind="click: $root.createTask.createTask,
                             ltext: 'task.create',
                             visible: $root.authorization.ok('create-task'),
                             enable: $root.authorization.ok('create-task')"></button>
        </div>
      </div>
    </div>
    <div id="boxes">

      <div id="dialog-invite-foreman" class="window autosized">
        <div class="dialog-header">
          <p data-bind="ltext: 'application.parties.addForeman'"></p>
          <p class="dialog-close close">X</p>
        </div>
        <!-- ko with: $root.foreman -->
        <div class="dialog-content" data-bind="css: {pending: pending, finished: finished}">
          <div class="finished">
            <p class="dialog-desc-wide" data-bind="lhtml: 'invite.foreman.finished'"></p>
            <button data-test-id="application-invite-foreman-close-dialog"
                    class="btn btn-dialog btn-primary"
                    data-bind="ltext: 'button.ok', click: function() { openApplication(finished()); LUPAPISTE.ModalDialog.close(); }"></button>
            <a class="btn btn-dialog" data-bind="ltext: 'application.return', click: function() { LUPAPISTE.ModalDialog.close(); }"></a>
          </div>
          <div class="pending">
            <div class="ajax"></div>
            <div data-bind="ltext: 'invite.foreman.pending'"></div>
          </div>
          <!-- ko ifnot: finished -->
          <p data-bind="lhtml: 'invite.foreman.desc'" class="dialog-desc-wide"></p>
          <form>
            <label for="foreman-role" data-bind="ltext: 'foreman.role'"></label>
            <select name="foreman-role" class="form-input combobox long"
                    data-bind="options: foremanRoles,
                               optionsText: function(item) { return loc(item.i18nkey); },
                               optionsValue: 'name',
                               value: selectedRole,
                               optionsCaption: loc('choose')"></select>

            <label data-bind="ltext: 'userinfo.email'" class="form-label" for="invite-foreman-email"></label>
            <input class="form-input text long" id="invite-foreman-email" type="text" data-bind="textInput: email" autofocus></input>
            <div data-bind="visible: error" >
              <div data-bind="ltext: error" class="context-error"></div>
            </div>
            <button class="btn btn-primary btn-dialog" data-test-id="application-invite-foreman" data-bind="click: submit, disable: disabled">
              <span data-bind="ltext: 'application.inviteSend'"></span>
              <em data-bind="visible: pending" class="button-loader"></em>
            </button>
            <a data-bind="ltext: 'cancel'" class="btn-dialog close cancel" onclick="window.parent.hub.send('upload-cancelled');return false;" href="#"></a>
          </form>
          <!-- /ko -->
        </div>
        <!-- /ko -->
      </div>

      <div id="dialog-valtuutus" class="window autosized">
        <div class="dialog-header">
          <p data-bind="ltext: 'application.addInvite'">Lis&auml;&auml; valtuutus</p>
          <p class="dialog-close close">X</p>
        </div>
        <div class="dialog-content">
          <p data-bind="ltext: 'invite.desc'" class="dialog-desc"> </p>
          <form data-bind="with: $root.invite">
            <!-- label data-bind="ltext: 'userinfo.role'" class="form-label" for="invite-document"></label -->
            <input class="form-input text long" id="invite-document-name" disabled="disabled" type="hidden" data-bind="value: documentName" />
            <input class="form-input text long" id="invite-document-id" disabled="disabled" type="hidden" data-bind="value: documentId" />
            <input class="form-input text long" id="invite-document-path" disabled="disabled" type="hidden" data-bind="value: path" />
            <label data-bind="ltext: 'userinfo.email'" class="form-label" for="invite-email"></label>
            <input class="form-input text long" id="invite-email" type="text" data-bind="textInput: email" />
            <label data-bind="ltext: 'application.inviteMessage'" class="form-label" for="invite-text"></label>
            <textarea id="invite-text" rows=10 class="form-input textarea really-long high" data-bind="textInput: text"></textarea>
            <div data-bind="visible: error" >
              <div data-bind="text: error" class="context-error"></div>
            </div>
            <button class="btn btn-primary btn-dialog" data-test-id="application-invite-submit" data-bind="click: submit, disable: disabled">
              <span data-bind="ltext: 'application.inviteSend'"></span>
              <em data-bind="visible: pending" class="button-loader"></em>
            </button>
          </form>
        </div>
      </div>

      <div id="dialog-request-for-statement" class="window autosized">
        <div class="dialog-header">
         <p data-bind="ltext: 'application.statement.add'"></p>
         <p class="dialog-close close">X</p>
        </div>
        <div class="dialog-content" data-bind="with: $root.requestForStatementModel">
          <div data-bind="foreach: data()" class="scrolling-content">
            <input class="form-input" type="checkbox" data-test-id="check-statement-giver"
                   data-bind="value: id, checked: $root.requestForStatementModel.personIds, attr: {'id': id, 'data-test-id' : 'check-statement-giver-' + $index()}" />
            <label data-bind="text: text()+' '+name() + ' (' + email() + ')', attr: {'for': id}" class="form-label"></label><br/>
          </div>
          <button
              data-bind="click: send, ltext: 'application.statement.send', disable: disabled"
              class="btn btn-primary modal"
              data-test-id="add-statement-giver">
          </button>
          <img class="own-info-ajax-loader" data-bind="visible: submitting" style="display: none" src="/img/ajax-loader-12.gif" alt="..." width="12" height="12"/>
        </div>
      </div>

      <div id="dialog-add-attachment-templates" class="window autosized selectm-dialog">
        <div class="dialog-header">
          <p data-bind="ltext: 'application.newAttachmentTemplates'"></p>
          <p class="dialog-close close">X</p>
        </div>
        <div class="dialog-content">
          <div class="attachment-templates"></div>
        </div>
      </div>

      <div id="dialog-send-neighbor-email" class="window autosized">
        <div data-bind="with: $root.sendNeighborEmailModel">
          <div class="dialog-header">
            <p data-bind="ltext: 'neighbors.sendEmail.title'"></p>
            <p class="dialog-close close">X</p>
          </div>
          <div class="dialog-content">

            <form>
              <label data-bind="ltext: 'neighbors.sendEmail.name'" class="form-label"></label>
              <span data-bind="text: name"
                    id="neighbors-sendemail-name"
                    class="form-input text long">
              </span>

              <label data-bind="ltext: 'neighbors.sendEmail.email'" class="form-label" for="neighbors-sendemail-email"></label>
              <input data-bind="textInput: email,
                                attr: {placeholder: loc('neighbors.sendEmail.email.placeholder')}"
                     id="neighbors-sendemail-email"
                     class="form-input text long" />
            </form>

            <button data-bind="click: send, ltext: 'neighbors.sendEmail.ok', enable: ok"
                    data-test-id="neighbors-sendemail-send"
                    class="btn btn-primary btn-dialog">
            </button>
            <button data-bind="ltext: 'neighbors.sendEmail.cancel'" class="btn btn-dialog close"></button>

          </div>
        </div>
      </div>

      <div id="dialog-add-party" class="window autosized">
        <div data-bind="with: $root.addPartyModel">
          <div class="dialog-header">
            <p data-bind="ltext: 'addParty.heading'"></p>
            <p class="dialog-close close">X</p>
          </div>
          <div class="dialog-content">
            <div>
              <select
                data-bind="options: partyDocumentNames(),
                           optionsText: function(item) { return loc(['schemas', item]); },
                           optionsValue: function(item) { return item; },
                           value: documentName,
                           optionsCaption: loc('choose')"
                data-test-id="select-party-document">
              </select>
              <button data-bind="click: addParty, ltext: 'add', enable: addPartyEnabled()" class="btn btn-primary btn-dialog close" data-test-id="add-party-button"></button>
            </div>
          </div>
        </div>
      </div>

      <div id="dialog-neighbor-status" class="window autosized">
        <div class="dialog-header">
          <p data-bind="ltext: 'neighbors.status-dialog.title'"></p>
          <p class="dialog-close close">X</p>
        </div>
        <div data-bind="with: neighborStatusModel" class="dialog-content">

          <div data-bind="text: loc(['neighbors.status-dialog.message', state()])"></div>
          <div data-bind="text: loc(['neighbors.status-dialog.description', state()])"></div>

          <table>
            <tbody>
              <tr>
                <td data-bind="ltext: 'neighbors.status-dialog.user.firstName'"></td>
                <td data-bind="text: firstName" data-test-id="neighbor-status-firstName"></td>
              </tr>
              <tr>
                <td data-bind="ltext: 'neighbors.status-dialog.user.lastName'"></td>
                <td data-bind="text: lastName" data-test-id="neighbor-status-lastName"></td>
              </tr>
              <tr data-bind="if: userid">
                <td data-bind="ltext: 'neighbors.status-dialog.user.userid'"></td>
                <td data-bind="text: userid" data-test-id="neighbor-status-userid"></td>
              </tr>
            </tbody>
          </table>

          <div>
            <span data-bind="ltext: 'neighbors.status-dialog.user.time'"></span>:
            <span data-bind="dateTimeString: created"></span>
          </div>

          <div data-bind="visible: message">
            <div data-bind="text: loc(['neighbors.status-dialog.message-title', state()])"></div>
            <div data-bind="text: message"  data-test-id="neighbor-status-message" class="neighbors-message"></div>
          </div>

          <button data-bind="ltext: 'neighbors.status-dialog.ok'" data-test-id="neighbor-status-ok" class="btn btn-primary btn-dialog close"></button>

        </div>
      </div>

    </div>

  </section>

  <div style="display:none;">
    <div id="dialog-company-user-op" class="window autosized">
      <div class="dialog-header">
        <p data-bind="text: title"></p>
        <p class="dialog-close close">X</p>
      </div>
      <div class="dialog-content">

        <div>
          <span data-bind="html: message"></span>
        </div>

        <div data-bind="visible: pending">
          <em class="button-loader" style="position: relative;"></em>
          <span data-bind="ltext: 'company.user.op.pending'"></span>
        </div>

        <button data-bind="click: ok,
                           enable: !pending(),
                           ltext: 'yes'"
                class="btn btn-primary btn-dialog"
                data-test-id="dialog-company-user-op.ok">
        </button>
        <button data-bind="enable: !pending(),
                           ltext: 'no'"
                class="btn btn-dialog close">
        </button>

      </div>
    </div>
  </div>


</body>
</html>
