<!DOCTYPE html>
<html>
<body>
  <section class="page container" id="comments">
    <script type="text/html" id="comment-template">
      <div data-bind="with: $data.comment">
        <form>
          <h3 data-bind="ltext: 'application.conversationPrompt'">Kirjoita viesti:</h3>
          <textarea
            data-bind="attr: {placeholder: loc('comment.placeholder')}, value: text, valueUpdate: 'afterkeydown'"
            data-test-id="application-new-comment-text"
            class="form-input textarea"
            rows="3"
            maxlength="4000">
          </textarea>
          <button
            data-bind="visible: $root.authorization.ok('add-comment'), disable: disabled, click: submit"
            data-test-id="application-new-comment-btn"
            type="submit"
            class="btn btn-primary">
            <span data-bind="ltext: 'application.conversationSend'"></span>
            <em data-bind="visible: pending" class="button-loader"></em>
          </button>

          <button
            data-bind="visible: $root.authorization.ok('open-application'), disable: disabled, click: stateOpenApplication"
            data-test-id="application-open-application-btn"
            type="submit"
            class="btn btn-primary">
            <span data-bind="ltext: 'application.conversationOpen'"></span>
            <em data-bind="visible: pending" class="button-loader"></em>
          </button>

          <div data-bind="with: $parent.authorities, visible: $root.authorization.ok('can-target-comment-to-authority')" class="comment-controls">
            <div class="mark-answered" data-bind="visible: $root.application.infoRequest">
              <button
                data-bind="visible: $root.authorization.ok('add-comment'), click: $parent.markAnswered"
                data-test-id="comment-request-mark-answered"
                type="submit"
                class="btn btn-primary">
                <span data-bind="ltext: 'comment-request-mark-answered-label'"></span>
              </button>
            </div>
            <div class="comment-request">
              <label data-bind="ltext: 'comment-request-label'"></label>
              <select
                data-bind="options: $data,
                           optionsText: function(item) { return item.firstName + ' ' + item.lastName; },
                           optionsValue: 'id',
                           value: $parent.to,
                           optionsCaption: loc('comment-request-prompt')"
                data-test-id="application-assigneed-authority">
              </select>
            </div>

          </div>
        </form>
        <div class="comment-toggle" data-bind="if: $parent.mainConversation">
          <input type="checkbox" id="show-attachment-comments" data-bind="checked: hideAttachmentComments"></>
          <label for="show-attachment-comments" data-bind="ltext: 'conversation.attachment.toggle'"></label>
        </div>

        <div class="table table-striped conversation" data-test-id="comments-table">
          <div data-bind="foreach: comments().reverse()">
            <div data-bind="css: {'attachment-comment': $parent.isForNewAttachment($data),
                                 'comment-for-me':     $parent.isForMe($data),
                                 'authority-comment':  $parent.isAuthorityComment($data),
                                 'comment':            true},
                           visible: !($parent.isForNewAttachment($data) && $parent.hideAttachmentComments())">
              <div class="comment-party commenttd">
                <span class="date" data-bind="dateTimeString: created"></span>
                <br />
                <span class="author" data-bind="fullName: user"></span>
                <span data-bind="with: $data.to">
                  --> <span class="author" data-bind="fullName: $data"></span>
                </span>
                <br />
                <b>(<span class="role" data-bind="ltext: user.role"></span>)</b>
              </div>
              <div class="comment-text">
                <span data-bind="if: $parents[1].mainConversation">
                  <span data-bind="if: $parent.isForAttachment($data)" class="attachment-details">
                    <span data-bind="if: target.id()">
                    <a data-bind="attr: {href: '#!/attachment/' + $root.application.id() + '/' + target.id()}">
                      <span data-bind="text: target.attachmentType"></span>
                    </a></span>
                  </span>
                </span>
                <span data-bind="if: $parent.isForNewAttachment($data)" class="new-attachment-version-details">
                  <span data-bind="ltext: 'newAttachmentVersion'"></span>
                  <span data-bind="version: target.version"></span>:
                  <a data-bind="text: target.filename, attr: {href: '/api/raw/download-attachment?attachment-id=' + target.fileId()}"></a>
                </span>
                <span data-bind="text: text"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </script>
  </section>
</body>
