<!DOCTYPE html>
<html>
<body>
  <section class="page container" id="comments">
    <script type="text/html" id="comment-template">
      <div data-bind="with: $data.comment">
        <form>
          <h3 data-bind="ltext: 'application.conversationPrompt'">Kirjoita viesti:</h3>
          <textarea
            data-bind="attr: {placeholder: loc('comment.placeholder')}, textInput: text, hasFocus: isSelected"
            data-test-id="application-new-comment-text"
            class="form-input textarea"
            rows="3"
            maxlength="4000">
          </textarea>
          <button
            data-bind="visible: $parent.authorization.ok('add-comment'), disable: disabled, click: stateOpenApplication"
            data-test-id="application-open-application-btn"
            type="submit"
            class="btn btn-primary">
            <span data-bind="ltext: 'application.conversationOpen'"></span>
            <em data-bind="visible: pending" class="button-loader"></em>
          </button>
          <button
            data-bind="visible: $parent.authorization.ok('add-comment'), disable: disabled, click: submit"
            data-test-id="application-new-comment-btn"
            type="submit"
            class="btn btn-primary">
            <span data-bind="ltext: 'application.conversationSend'"></span>
            <em data-bind="visible: pending" class="button-loader"></em>
          </button>



          <div data-bind="visible: $parent.authorization.ok('can-target-comment-to-authority') || $parent.authorization.ok('can-mark-answered')" class="comment-controls">
            <div class="mark-answered" data-bind="if: $parent.authorization.ok('can-mark-answered')">
              <button
                data-bind="click: markAnswered"
                data-test-id="comment-request-mark-answered"
                type="submit"
                class="btn btn-primary">
                <span data-bind="ltext: 'comment-request-mark-answered-label'"></span>
              </button>
            </div>
            <div class="comment-request" data-bind="if: $parent.authorization.ok('can-target-comment-to-authority')">
              <label data-bind="ltext: 'comment-request-label'"></label>
              <select
                data-bind="options: $parent.authorities,
                           optionsText: function(item) { return item.lastName + ' ' + item.firstName; },
                           optionsValue: 'id',
                           value: to,
                           optionsCaption: loc('comment-request-prompt')"
                data-test-id="side-panel-assigneed-authority">
              </select>
            </div>

          </div>
        </form>
        <div class="comment-toggle" data-bind="if: $parent.mainConversation">
          <input type="checkbox" id="show-attachment-comments" data-bind="checked: showAttachmentComments">
          <label for="show-attachment-comments" data-bind="ltext: 'conversation.attachment.toggle'"></label>
          <div data-bind="if: $parent.authorization.ok('save-verdict-draft')">
            <input type="checkbox" id="show-preparation-comments" data-bind="checked: showPreparationComments">
            <label for="show-preparation-comments" data-bind="ltext: 'conversation.preparation.toggle'"></label>
          </div>
        </div>

        <div class="table table-striped conversation" data-test-id="comments-table">
          <div data-bind="foreach: comments().slice(0).reverse()">
            <!-- ko if: !($parents[1].infoRequest() && $parent.isForAttachment($data)) -->
            <div data-bind="css: {'attachment-comment': $parent.isForAttachment($data),
                                  'comment-for-me':     $parent.isForMe($data),
                                  'authority-comment':  $parent.isAuthorityComment($data),
                                  'comment':            true},
                           visible: $parent.isVisible($data)">
              <div class="comment-party commenttd">
                <span class="date" data-bind="dateTimeString: created"></span>
                <span class="author" data-bind="fullName: user"></span>
                <!-- ko with: $data.to -->
                  <span class="arrow"></span>
                  <span class="author" data-bind="fullName: $data"></span>
                <!-- /ko -->
                <span class="role" data-bind="ltext: user.role"></span>
              </div>
              <div class="comment-text">
                <span data-bind="if: $parent.isForAttachment($data)" class="attachment-details">
                  <span data-bind="if: target.id()">
                    <!-- ko if: target.attachmentType -->
                    <a data-bind="attr: {href: '#!/attachment/' + $parent.applicationId + '/' + target.id()}">
                      <span data-bind="text: target.attachmentType"></span>
                    </a>
                    <!-- /ko -->
                    <!-- ko ifnot: target.attachmentType -->
                    <span class="deleted-attachment" data-bind="ltext: 'attachment.removed'"></span>
                    <!-- /ko -->
                  </span>
                </span>
                <span data-bind="text: text" class="comment-message"></span>
              </div>
            </div>
            <!-- /ko -->
          </div>
        </div>
      </div>
    </script>
  </section>
</body>
